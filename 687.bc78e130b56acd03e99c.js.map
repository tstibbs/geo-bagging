{"version":3,"sources":["webpack://@tstibbs/geo-bagging-ui/./src/js/bundles/abstract_bundle_builder.js","webpack://@tstibbs/geo-bagging-ui/./src/js/bundles/abstract_geojson_builder.js","webpack://@tstibbs/geo-bagging-ui/./src/js/bundles/abstract_points_builder.js","webpack://@tstibbs/geo-bagging-ui/./src/js/bundles/external-geojson/config.js","webpack://@tstibbs/geo-bagging-ui/./src/js/bundles/external-gpx/config.js","webpack://@tstibbs/geo-bagging-ui/./src/js/bundles|lazy|/^\\.\\/.*\\.js$/|groupOptions: {}|strict namespace object","webpack://@tstibbs/geo-bagging-ui/./src/js/config.js","webpack://@tstibbs/geo-bagging-ui/./src/js/constants.js","webpack://@tstibbs/geo-bagging-ui/./src/js/conversion.js","webpack://@tstibbs/geo-bagging-ui/./src/js/fullscreen_link.js","webpack://@tstibbs/geo-bagging-ui/./src/js/global.js","webpack://@tstibbs/geo-bagging-ui/./src/js/mobile.js","webpack://@tstibbs/geo-bagging-ui/./src/js/leaflet-plugins/zoom-detector.js","webpack://@tstibbs/geo-bagging-ui/./src/js/vendor-wrappers/bing-layer.js","webpack://@tstibbs/geo-bagging-ui/./src/js/layers.js","webpack://@tstibbs/geo-bagging-ui/./src/js/map_view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/vendor-wrappers/leaflet-marker-cluster.js","webpack://@tstibbs/geo-bagging-ui/./src/js/vendor-wrappers/leaflet-subgroup.js","webpack://@tstibbs/geo-bagging-ui/./src/js/marker_view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/settings/clustering_enabled_control.js","webpack://@tstibbs/geo-bagging-ui/./src/js/points_view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/geojson_view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/utils/url_handler.js","webpack://@tstibbs/geo-bagging-ui/./src/js/model_views.js","webpack://@tstibbs/geo-bagging-ui/./src/js/source_loader.js","webpack://@tstibbs/geo-bagging-ui/./src/js/vendor-wrappers/leaflet-matrix-layers-control.js","webpack://@tstibbs/geo-bagging-ui/./src/js/vendor-wrappers/leaflet-control-hider.js","webpack://@tstibbs/geo-bagging-ui/./src/js/selection.js","webpack://@tstibbs/geo-bagging-ui/./src/js/locate.js","webpack://@tstibbs/geo-bagging-ui/./src/js/vendor-wrappers/leaflet-mouse-position.js","webpack://@tstibbs/geo-bagging-ui/./src/js/mouseposition_osgb.js","webpack://@tstibbs/geo-bagging-ui/./src/js/vendor-wrappers/leaflet-map-center-coord.js","webpack://@tstibbs/geo-bagging-ui/./src/js/screenposition_osgb.js","webpack://@tstibbs/geo-bagging-ui/./src/js/vendor-wrappers/sidebar.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/attribution.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/user.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/settings/view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/utils/external-source-loader.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/external-files/files_view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/external-files/file_load_view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/constraints/file-constraint-load-view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/constraints/track_load_view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/constraints/current_location_view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/constraints/current_area_view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/constraints/geo-json-load-view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/constraints/view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/external-files/files_load_panel.js","webpack://@tstibbs/geo-bagging-ui/./src/js/menu/view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/controls.js","webpack://@tstibbs/geo-bagging-ui/./src/js/manager.js","webpack://@tstibbs/geo-bagging-ui/./src/js/map_loader.js","webpack://@tstibbs/geo-bagging-ui/./src/js/params.js","webpack://@tstibbs/geo-bagging-ui/./src/js/popup_view.js","webpack://@tstibbs/geo-bagging-ui/./src/js/utils/geojson-translator.js","webpack://@tstibbs/geo-bagging-ui/./src/js/utils/geojson.js","webpack://@tstibbs/geo-bagging-ui/./src/js/vendor-wrappers/leaflet.js"],"names":["initialize","manager","bundleConfig","bundleName","this","_markerList","_manager","_config","getConfig","_bundleConfig","_bundleName","indexOf","substring","lastIndexOf","_urlPrefix","dataLocationUrlPrefix","baseUrl","_visits","_buildDataUrl","dataToLoad","_doFetchData","dataLoadPromise","url","dataType","fail","xhr","textError","error","console","log","shouldManageVisits","visitsLoadPromise","xhrFields","withCredentials","then","data","map","visit","bind","datas","fetchMeta","done","_meta","getMeta","getVisits","getBundleConfig","_data","_translator","initialOutlineWidth","fetchData","_parseDatas","features","feature","parse","buildLayers","layerDatas","dataToLayers","getAttribution","attribution","addMarkers","pointsToLoad","i","length","_attributionText","addMarker","id","lat","lng","name","extraTexts","icon","dimensionValues","layerId","marker","encodeURIComponent","latLng","parseFloat","exportName","visited","dimensional_layering","_withinConstraints","currentMap","key","lastKey","push","matcher","getViewConstraints","buildImageLinks","linksArray","elem","index","split","values","labels","value","label","getMarkerList","aspectLabel","loadLabel","loadExtensions","colour","fileContentsParser","webpackAsyncContext","req","__webpack_require__","o","Promise","resolve","e","Error","code","ids","all","slice","keys","Object","module","exports","defaultPageId","pop","defaults","window","geoBaggingBaseUrl","map_style","cluster","initial_zoom","start_position","force_config_override","map_element_id","map_outer_container_element","page_id","show_zoom_control","show_selection_control","show_search_control","show_locate_control","show_layers_control","show_position_control","show_hider_control","use_sidebar","hider_control_start_visible","icons","dimensionNames","dimensionValueLabels","defaultLayer","markerConstraints","options","configBundles","resolvedConfig","_checkForUndefaultedProperties","bundles","_storageId","saved","_getSavedConfig","property","_buildMarkerConstraints","hasOwnProperty","constraintsString","points","tlLat","tlLng","brLat","brLng","topLeft","bottomRight","Array","isArray","markerConstraintsMatcher","contains","newConfig","source","warn","undefined","localStorage","getItem","JSON","persist","setItem","stringify","baseBackendUrl","bingKey","dataSources","legacyApiBackendBaseUrl","dataBackendBaseUrl","integrationBackendBaseUrl","osgbProj","pad","num","w","n","toString","latLngToGridRef","digits","out","forward","eastings","northings","Number","isNaN","e100k","Math","floor","n100k","l1","l2","letPair","String","fromCharCode","charCodeAt","pow","osgbToLngLat","inverse","gridRefToOsgb","gridref","trim","_determineGridRefType","match","OsGridRef","toUpperCase","e100km","n100km","en","parseInt","gridRefToLngLat","lngLat","test","config","leafletMap","link","click","zoom","getZoom","centre","getCenter","newUrl","location","href","append","firstRegex","secondRegex","devHack","params","testString","global","substr","ZOOM_OUT_EVENT","constants","bingDefaults","leaflet","maxZoom","minZoom","detectRetina","bingOsLayer","imagerySet","maxNativeZoom","bingFallbackLayer","bingOsGroup","bingRoads","bingHybrid","bingAerial","osm","OS","OSM","max","maxOverallZoom","min","minOverallZoom","layerZoomExtractor","layers","MAX_SAFE_INTEGER","forEach","layer","getLayers","subLayersMax","subLayersMin","_listenForLayerChange","on","layerToSelect","addTo","_createView","_map","zoomControl","setView","fullscreen_link","_saveLocation","previousZoom","currentZoom","isInteger","debug","fire","detectZoomDirection","content","mapClass","addClass","mobile","prepend","center","hash","getMap","markerConfig","aspectName","popupText","markerOptions","defaultIcon","popupElem","change","endpoint","checked","contentType","catch","jqXhr","textStatus","errorThrown","status","bindPopup","cmt","desc","exportData","ENABLE_CLUSTERING_EVENT","DISABLE_CLUSTERING_EVENT","ClusteringEnabledControl","_view","_clusteringEnabled","lastDisabledZoomLevel","event","target","prop","trigger","clusteringInfo","getView","modelsByAspect","matrixLayerControl","controls","_modelsByAspect","_matrixLayerControl","_controls","_bundles","_parentGroup","_translateMarkerGroup","group","aspect","constructor","dimension","finish","finished","deferredObject","mapElem","radius","offsetHeight","offsetWidth","disableClusteringAtZoom","maxClusterRadius","chunkedLoading","chunkProgress","processed","total","elapsed","layersArray","enableClustering","disableClustering","model","addClusteredModel","markerLists","filter","allMarkers","concat","apply","nullLayerId","markersByLayer","reduce","addLayers","markers","layerGroup","addLayer","promise","markerList","matrixOverlays","depthFirstIteration","aspectOptions","addAspect","path","overlays","subGroup","dimValue","newPath","sublist","_tester","sourceLoaded","sourceName","update","getParams","datasource","newParams","paramKey","join","document","origin","pathname","getControls","_urlHandler","_filterModels","bundleModels","className","matchingModels","_addLazyModels","lazyModels","addCallback","callback","_addAttribution","meta","description","recordCount","lastUpdated","bundleDetails","getMatrixLayerControl","addLazyAspect","dataSourceLabel","addAttribution","loadModelViews","pointsModels","geojsonModels","lazyPointsModels","lazyGeojsonModels","pointsView","geojsonView","promises","always","addControl","loadSources","selectedSourceIds","extraDataSourcesString","extraDataSources","sourceIds","sourceModuleIds","_sourceIdsToDataSources","sources","modules","sourceModule","default","sourceModels","parser","metaPromise","dataPromise","_finish","setTimeout","allSources","hide","actions","gpx","display","action","d","Date","getFullYear","getMonth","getDate","getHours","getMinutes","getSeconds","keepCurrentZoomLevel","formatter","conversion","onMove","latLngFormatter","_addShowHideHandling","$icon","isIconVisible","hideIcon","css","container","_container","copyright","dataSourceName","text","isAuthenticated","getLoggedInUser","clusteringEnabledControl","_displayedSources","fileNameToLayers","includes","entries","fileName","_addMatrixOverlay","_setLayerVis","_onInputClick","_update","hideLayers","remove","visible","_model","inputChanged","_sourceName","_layers","_externalSourceLoader","hideOldLayers","showNewLayers","files","layerData","geojson","newLayers","bundle","_bundle","_fileInput","_readFiles","_fileCounter","_filesView","file","reader","FileReader","onload","parsed","_parseFileContents","result","_finishedReadingFiles","readAsText","item","fileContents","bounds","constraintsView","_constraintsView","tracks","combinedBounds","track","flat","limitTo","reset","val","configBundle","currentLocationLimitButton","_limitToCurrentLocation","listener","off","latlng","latLngBounds","stopLocate","locate","_currentAreaLimit","getBounds","unlimit","GeoJsonConstraintLoadView","_limitOriginView","info","currentAreaView","currentLocationView","_trackConstraintsLoadView","_geoJsonConstraintLoadView","_buildReset","wrapper","limitOriginView","setViewConstraints","_buildLimitFunction","_constraintPolygon","polygonPoints","hole","getSouthWest","getNorthWest","getNorthEast","getSouthEast","L","Polygon","color","fillColor","fillOpacity","geojsonLoadView","gpxLoadView","_buildView","_buildControl","view","showUserSettings","attributionContainer","_attributionView","userView","settingsView","externalFilesView","_control","getContainer","order","_controlsToHide","_controlsToAdd","_addDefaults","_addAllTo","configOverrides","_menuView","position","showPopup","provider","visibleByDefault","control","oldControl","found","newContainer","oldContainer","replaceWith","_authenticated","_initializePromise","deferred","_loggedInUser","email","multiAspects","embeddable","waitForInitialization","limitFunction","_limitFunction","setAuthenticated","authenticated","getBundleIds","allBundles","dataSourcesString","loadMap","bundleIds","hasUrlData","alert","generalPoints","mapView","_buildMap","loadMiniMap","ParamChecker","_params","search","tmp","decodeURIComponent","defaultInstance","tester","notEmpty","input","_truncateDisplayString","maxDisplayTextLength","_truncateDisplayArray","_buildValue","_escapeValue","buildShortDescription","extractValue","buildDescription","keyAndVal","buildPopup","unescapedName","unescapedUrl","unescapedExtraTexts","_colour","_initialOutlineWidth","_showAsSelected","setStyle","weight","_extractName","extraInfos","findAndExtract","regex","fallback","findIndex","splice","nameProperties","fallBackProperties","nameRegex","properties","_buildExtraInfos","featureProperties","infos","gpxPropsToIgnore","gpxPrefixesToIgnore","filterPropName","propName","some","prefix","startsWith","entry","linkValues","fromEntries","nameToFeatures","onFeatureClick","featureName","geoJsonLayer","onEachFeature","featureExtraInfos","popup","preclick","resetStyle","calcGeoJsonBounds","geoJson","type","minLng","maxLng","minLat","maxLat","geometry","pointParser","point","lineParser","line","coordinates","polygon","bottomLeft","topRight","rawGpxToGeoJson","gpxAsString","replace","dom","DOMParser","parseFromString","rawGeoJsonToGeoJson","geojsonAsString","iconRetinaUrl","iconUrl","shadowUrl"],"mappings":"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","file":"687.bc78e130b56acd03e99c.js","sourcesContent":["import leaflet from 'VendorWrappers/leaflet.js'\nimport $ from 'jquery'\nimport constants from '../constants.js'\n\nvar AbstractBundleBuilder = leaflet.Class.extend({\n\tinitialize: function (manager, bundleConfig, bundleName) {\n\t\tthis._markerList = null\n\t\tthis._manager = manager\n\t\tthis._config = manager.getConfig()\n\t\tthis._bundleConfig = bundleConfig\n\t\tthis._bundleName = bundleName.indexOf('/') == -1 ? bundleName : bundleName.substring(0, bundleName.lastIndexOf('/'))\n\t\tthis._urlPrefix = this._bundleConfig.dataLocationUrlPrefix ?? `${this._config.baseUrl}bundles/`\n\t\tthis._visits = []\n\t},\n\n\t_buildDataUrl: function () {\n\t\treturn this._urlPrefix + this._bundleName + '/' + this._bundleConfig.dataToLoad\n\t},\n\n\t_doFetchData: function () {\n\t\tvar dataToLoad = this._buildDataUrl()\n\t\tvar dataLoadPromise = $.ajax({\n\t\t\turl: dataToLoad,\n\t\t\tdataType: 'json'\n\t\t}).fail(function (xhr, textError, error) {\n\t\t\tconsole.error('Failed to load map data: ' + textError)\n\t\t\tconsole.log(error)\n\t\t})\n\n\t\tif (this._manager.shouldManageVisits()) {\n\t\t\t//not loading visits is ok, because we won't display the info either if not authenticated\n\t\t\tvar visitsLoadPromise = $.get({\n\t\t\t\turl: constants.legacyApiBackendBaseUrl + 'listVisits?source=' + this._bundleName,\n\t\t\t\tdataType: 'json',\n\t\t\t\txhrFields: {\n\t\t\t\t\twithCredentials: true\n\t\t\t\t}\n\t\t\t})\n\t\t\t\t.then(\n\t\t\t\t\tfunction (data) {\n\t\t\t\t\t\tthis._visits = data.map(\n\t\t\t\t\t\t\tfunction (visit) {\n\t\t\t\t\t\t\t\t//each visit file is named like \"visits-hills-16495\", so get everything after the second hyphen\n\t\t\t\t\t\t\t\treturn visit.substring(visit.indexOf('-', visit.indexOf('-') + 1) + 1)\n\t\t\t\t\t\t\t}.bind(this)\n\t\t\t\t\t\t)\n\t\t\t\t\t}.bind(this)\n\t\t\t\t)\n\t\t\t\t.fail(function (xhr, textError, error) {\n\t\t\t\t\tconsole.error('Failed to load map data: ' + textError)\n\t\t\t\t\tconsole.log(error)\n\t\t\t\t})\n\n\t\t\treturn $.when(dataLoadPromise, visitsLoadPromise).then(function (datas) {\n\t\t\t\treturn datas[0] //only need to pass the actual data on, not the visits\n\t\t\t})\n\t\t} else {\n\t\t\treturn dataLoadPromise\n\t\t}\n\t},\n\n\tfetchMeta: function () {\n\t\tvar dataToLoad = this._buildDataUrl() + '.meta'\n\t\treturn $.ajax({\n\t\t\turl: dataToLoad,\n\t\t\tdataType: 'json'\n\t\t})\n\t\t\t.fail(function (xhr, textError, error) {\n\t\t\t\tconsole.error('Failed to load source metadata: ' + textError)\n\t\t\t\tconsole.log(error)\n\t\t\t})\n\t\t\t.done(\n\t\t\t\tfunction (data) {\n\t\t\t\t\tthis._meta = data\n\t\t\t\t}.bind(this)\n\t\t\t)\n\t},\n\n\tgetMeta: function () {\n\t\treturn this._meta\n\t},\n\n\tgetVisits: function () {\n\t\treturn this._visits\n\t},\n\n\tgetBundleConfig: function () {\n\t\treturn this._bundleConfig\n\t}\n})\n\nexport default AbstractBundleBuilder\n","import AbstractBundleBuilder from './abstract_bundle_builder.js'\nimport GeoJsonTranslator from '../utils/geojson-translator.js'\n\nconst colour = '#3388ff'\n\nvar GeojsonLayer = AbstractBundleBuilder.extend({\n\tinitialize: function (manager, bundleConfig, bundleName) {\n\t\tAbstractBundleBuilder.prototype.initialize.call(this, manager, bundleConfig, bundleName)\n\t\tthis._data = null\n\t\tthis._bundleConfig = bundleConfig\n\t\tthis._translator = new GeoJsonTranslator(manager, colour, bundleConfig.initialOutlineWidth)\n\t},\n\n\tfetchData: function () {\n\t\treturn this._doFetchData().done(\n\t\t\tfunction (data) {\n\t\t\t\tthis._data = data\n\t\t\t}.bind(this)\n\t\t)\n\t},\n\n\t_parseDatas: function () {\n\t\treturn this._data.features.map(\n\t\t\tfunction (feature) {\n\t\t\t\treturn this.parse(feature)\n\t\t\t}.bind(this)\n\t\t)\n\t},\n\n\tbuildLayers: function () {\n\t\tvar layerDatas = this._parseDatas()\n\t\treturn this._translator.dataToLayers(layerDatas)\n\t},\n\n\tgetAttribution: function () {\n\t\treturn this._bundleConfig.attribution\n\t}\n})\n\nexport default GeojsonLayer\n","import AbstractBundleBuilder from './abstract_bundle_builder.js'\n\nvar PointsBuilder = AbstractBundleBuilder.extend({\n\tinitialize: function (manager, bundleConfig, bundleName) {\n\t\tAbstractBundleBuilder.prototype.initialize.call(this, manager, bundleConfig, bundleName)\n\t\tthis._markerList = null\n\t\tthis._bundleConfig = bundleConfig\n\t},\n\n\tfetchData: function () {\n\t\treturn this._doFetchData().done(\n\t\t\tfunction (data) {\n\t\t\t\tthis.addMarkers(data)\n\t\t\t}.bind(this)\n\t\t)\n\t},\n\n\taddMarkers: function (data) {\n\t\tvar pointsToLoad = data.data\n\t\tfor (var i = 0; i < pointsToLoad.length; i++) {\n\t\t\tthis.parse(pointsToLoad[i])\n\t\t}\n\t\tif (this._bundleConfig.attribution != null) {\n\t\t\tthis._attributionText = this._bundleConfig.attribution\n\t\t} else {\n\t\t\tthis._attributionText = data.attribution\n\t\t}\n\t},\n\n\taddMarker: function (id, lat, lng, url, name, extraTexts, icon, dimensionValues, layerId) {\n\t\tid = encodeURIComponent(id)\n\t\tvar latLng = [parseFloat(lat), parseFloat(lng)]\n\t\tvar visited = this.getVisits().indexOf(id) != -1\n\t\tvar marker = {\n\t\t\tid: id, // for filtering purposes\n\t\t\tlatLng: latLng,\n\t\t\tname: name,\n\t\t\textraTexts: extraTexts,\n\t\t\texportName: name,\n\t\t\turl: url,\n\t\t\ticon: icon,\n\t\t\tlayerId: layerId,\n\t\t\tvisited: visited\n\t\t}\n\n\t\tif (this._config.dimensional_layering || dimensionValues == null || dimensionValues.length === 0) {\n\t\t\tif (this._markerList == null) {\n\t\t\t\tthis._markerList = {}\n\t\t\t}\n\n\t\t\tif (this._withinConstraints(marker)) {\n\t\t\t\tvar currentMap = this._markerList\n\t\t\t\tfor (var i = 0; i < dimensionValues.length - 1; i++) {\n\t\t\t\t\t// all but the last one\n\t\t\t\t\tvar key = dimensionValues[i]\n\t\t\t\t\tif (currentMap[key] == null) {\n\t\t\t\t\t\tcurrentMap[key] = {}\n\t\t\t\t\t}\n\t\t\t\t\tcurrentMap = currentMap[key]\n\t\t\t\t}\n\t\t\t\tvar lastKey = dimensionValues[dimensionValues.length - 1]\n\t\t\t\tif (currentMap[lastKey] == null) {\n\t\t\t\t\tcurrentMap[lastKey] = [] // set the last level to be an array\n\t\t\t\t}\n\t\t\t\tcurrentMap[lastKey].push(marker)\n\t\t\t}\n\t\t} else {\n\t\t\tif (this._markerList == null) {\n\t\t\t\tthis._markerList = []\n\t\t\t}\n\t\t\tthis._markerList.push(marker)\n\t\t}\n\t},\n\n\t_withinConstraints: function (marker) {\n\t\tvar matcher = this._manager.getViewConstraints()\n\t\treturn matcher == null || matcher(marker.latLng)\n\t},\n\n\tbuildImageLinks: function (linksArray) {\n\t\treturn linksArray.map(function (elem, index) {\n\t\t\treturn ['Image ' + (index + 1), elem]\n\t\t})\n\t},\n\n\tsplit: function (values, labels) {\n\t\treturn values.split(';').map(function (value) {\n\t\t\tvar label = labels[value]\n\t\t\treturn label != null ? label : value\n\t\t})\n\t},\n\n\tgetMarkerList: function () {\n\t\treturn this._markerList\n\t},\n\n\tgetAttribution: function () {\n\t\treturn this._attributionText\n\t}\n})\n\nexport default PointsBuilder\n","import {rawGeoJsonToGeoJson} from '../../utils/geojson.js'\n\nexport default {\n\taspectLabel: 'GeoJson Files',\n\tloadLabel: 'GeoJson',\n\tloadExtensions: '.geojson',\n\tcolour: 'darkblue',\n\tinitialOutlineWidth: 1,\n\tfileContentsParser: rawGeoJsonToGeoJson\n}\n","import {rawGpxToGeoJson} from '../../utils/geojson.js'\n\nexport default {\n\taspectLabel: 'GPX Files',\n\tloadLabel: 'GPX',\n\tloadExtensions: '.gpx',\n\tcolour: '#bd007e', //dark pinky crimson\n\tinitialOutlineWidth: 2,\n\tfileContentsParser: rawGpxToGeoJson\n}\n","var map = {\n\t\"./abstract_bundle_builder.js\": [\n\t\t6651\n\t],\n\t\"./abstract_geojson_builder.js\": [\n\t\t1865\n\t],\n\t\"./abstract_points_builder.js\": [\n\t\t7085\n\t],\n\t\"./coastallandmarks/config.js\": [\n\t\t7730,\n\t\t730\n\t],\n\t\"./coastallandmarks/points_builder.js\": [\n\t\t8657,\n\t\t657\n\t],\n\t\"./defence/config.js\": [\n\t\t5394,\n\t\t394\n\t],\n\t\"./defence/points_builder.js\": [\n\t\t7621,\n\t\t621\n\t],\n\t\"./external-geojson/config.js\": [\n\t\t8031\n\t],\n\t\"./external-gpx/config.js\": [\n\t\t2222\n\t],\n\t\"./follies/config.js\": [\n\t\t8897,\n\t\t897\n\t],\n\t\"./follies/points_builder.js\": [\n\t\t8602,\n\t\t602\n\t],\n\t\"./hills/config.js\": [\n\t\t3159,\n\t\t159\n\t],\n\t\"./hills/config_all.js\": [\n\t\t4544,\n\t\t544\n\t],\n\t\"./hills/points_builder.js\": [\n\t\t720,\n\t\t720\n\t],\n\t\"./milestones/config.js\": [\n\t\t320,\n\t\t320\n\t],\n\t\"./milestones/points_builder.js\": [\n\t\t514,\n\t\t514\n\t],\n\t\"./nationalparks/builder.js\": [\n\t\t5658,\n\t\t658\n\t],\n\t\"./nationalparks/config.js\": [\n\t\t4673,\n\t\t673\n\t],\n\t\"./nt/config.js\": [\n\t\t7368,\n\t\t368\n\t],\n\t\"./nt/points_builder.js\": [\n\t\t732,\n\t\t732\n\t],\n\t\"./rnli/config.js\": [\n\t\t9974,\n\t\t974\n\t],\n\t\"./rnli/points_builder.js\": [\n\t\t3166,\n\t\t166\n\t],\n\t\"./trails/builder.js\": [\n\t\t6023,\n\t\t23\n\t],\n\t\"./trails/config.js\": [\n\t\t7703,\n\t\t703\n\t],\n\t\"./trigs/config.js\": [\n\t\t8494,\n\t\t494\n\t],\n\t\"./trigs/config_base.js\": [\n\t\t7154,\n\t\t154\n\t],\n\t\"./trigs/config_embedding.js\": [\n\t\t4029,\n\t\t29\n\t],\n\t\"./trigs/config_mini.js\": [\n\t\t5769,\n\t\t769\n\t],\n\t\"./trigs/points_builder.js\": [\n\t\t4589,\n\t\t589\n\t]\n};\nfunction webpackAsyncContext(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\treturn Promise.resolve().then(() => {\n\t\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\t\te.code = 'MODULE_NOT_FOUND';\n\t\t\tthrow e;\n\t\t});\n\t}\n\n\tvar ids = map[req], id = ids[0];\n\treturn Promise.all(ids.slice(1).map(__webpack_require__.e)).then(() => {\n\t\treturn __webpack_require__(id);\n\t});\n}\nwebpackAsyncContext.keys = () => (Object.keys(map));\nwebpackAsyncContext.id = 2981;\nmodule.exports = webpackAsyncContext;","import leaflet from 'leaflet'\nimport $ from 'jquery'\nimport global from './global.js'\nimport params from './params.js'\nimport conversion from './conversion.js'\n\nvar defaultPageId = global.location.pathname.split('/').pop()\n\nvar defaults = {\n\tbaseUrl: window.geoBaggingBaseUrl != null ? window.geoBaggingBaseUrl : '',\n\tmap_style: 'full', //full, mini, embedded\n\tcluster: true,\n\tdimensional_layering: false,\n\tinitial_zoom: 13,\n\tstart_position: [53.374694, -1.711474], //lat, long\n\tforce_config_override: false, //if true, start position and zoom will be taken from config, not from local storage\n\tmap_element_id: 'map',\n\tmap_outer_container_element: $('body'),\n\tpage_id: defaultPageId,\n\tshow_zoom_control: true,\n\tshow_selection_control: true,\n\tshow_search_control: true,\n\tshow_locate_control: true,\n\tshow_layers_control: true,\n\tshow_position_control: true,\n\tshow_hider_control: 'mobile', // false, true, 'mobile'\n\tuse_sidebar: true,\n\thider_control_start_visible: true,\n\ticons: {},\n\tdimensionNames: [],\n\tdimensionValueLabels: {},\n\tdefaultLayer: 'OS',\n\tmarkerConstraints: null //e.g. will constrain it to show only those markers within a bounding boc\n}\n\nvar Config = leaflet.Class.extend({\n\tinitialize: function (options, configBundles) {\n\t\tvar resolvedConfig = $.extend({}, defaults, options)\n\t\tthis._checkForUndefaultedProperties(options, 'window config')\n\t\tresolvedConfig.bundles = configBundles\n\n\t\tthis._storageId = 'os_map:' + resolvedConfig.page_id + 'config'\n\n\t\tif (options == null || options.force_config_override !== true) {\n\t\t\t//check *options*, don't want to retrieve this persisted value\n\t\t\t//unless we've set the attribute to force override local config with the coded config, we should grab the local storage version and overwrite any matching keys\n\t\t\tvar saved = this._getSavedConfig()\n\t\t\tresolvedConfig = $.extend({}, resolvedConfig, saved)\n\t\t}\n\n\t\tif (params.test('startPosition')) {\n\t\t\t//lat, long\n\t\t\tresolvedConfig.start_position = params.test('startPosition').split(',')\n\t\t}\n\t\tif (params.test('startZoom')) {\n\t\t\tresolvedConfig.initial_zoom = params.test('startZoom')\n\t\t}\n\t\tthis._buildMarkerConstraints(resolvedConfig)\n\n\t\t//set all values locally so that the exporter object works like a hash\n\t\tfor (var property in resolvedConfig) {\n\t\t\tif (resolvedConfig.hasOwnProperty(property)) {\n\t\t\t\tthis[property] = resolvedConfig[property]\n\t\t\t}\n\t\t}\n\t},\n\n\t_buildMarkerConstraints: function (resolvedConfig) {\n\t\tvar constraintsString = null\n\t\tif (params.test('constraints') != null) {\n\t\t\t// params takes priority\n\t\t\tconstraintsString = params.test('constraints')\n\t\t} else if (resolvedConfig.markerConstraints != null && typeof resolvedConfig.markerConstraints == 'string') {\n\t\t\tconstraintsString = resolvedConfig.markerConstraints\n\t\t}\n\t\tif (constraintsString != null) {\n\t\t\tvar points = constraintsString.split(',')\n\t\t\tvar tlLat = null\n\t\t\tvar tlLng = null\n\t\t\tvar brLat = null\n\t\t\tvar brLng = null\n\t\t\tif (points.length == 2) {\n\t\t\t\t//must be os grid refs\n\t\t\t\tvar topLeft = conversion.gridRefToLngLat(points[0])\n\t\t\t\ttlLng = topLeft[0]\n\t\t\t\ttlLat = topLeft[1]\n\t\t\t\tvar bottomRight = conversion.gridRefToLngLat(points[1])\n\t\t\t\tbrLng = bottomRight[0]\n\t\t\t\tbrLat = bottomRight[1]\n\t\t\t} else {\n\t\t\t\t//lat,lng,lat,lng\n\t\t\t\ttlLat = parseFloat(points[0])\n\t\t\t\ttlLng = parseFloat(points[1])\n\t\t\t\tbrLat = parseFloat(points[2])\n\t\t\t\tbrLng = parseFloat(points[3])\n\t\t\t}\n\t\t\tresolvedConfig.markerConstraints = [\n\t\t\t\t[brLat, tlLng],\n\t\t\t\t[tlLat, brLng]\n\t\t\t] //<LatLng> southWest, <LatLng> northEast\n\t\t}\n\t\tif (resolvedConfig.markerConstraints != null && Array.isArray(resolvedConfig.markerConstraints)) {\n\t\t\tresolvedConfig.markerConstraints = leaflet.latLngBounds(resolvedConfig.markerConstraints) //[[bottom, left], [top, right]]\n\t\t}\n\t\tif (resolvedConfig.markerConstraints != null && typeof resolvedConfig.markerConstraints === 'function') {\n\t\t\tresolvedConfig.markerConstraintsMatcher = resolvedConfig.markerConstraints\n\t\t}\n\t\tif (resolvedConfig.markerConstraints != null && resolvedConfig.markerConstraintsMatcher == null) {\n\t\t\tresolvedConfig.markerConstraintsMatcher = function (marker) {\n\t\t\t\treturn resolvedConfig.markerConstraints.contains(marker.latLng)\n\t\t\t}\n\t\t}\n\t},\n\n\t_checkForUndefaultedProperties: function (newConfig, source) {\n\t\tfor (var property in newConfig) {\n\t\t\tif (newConfig.hasOwnProperty(property) && !defaults.hasOwnProperty(property)) {\n\t\t\t\tconsole.warn('Property \"' + property + '\" (set from ' + source + ') should have a default')\n\t\t\t}\n\t\t}\n\t},\n\n\t_getSavedConfig: function () {\n\t\tif (localStorage !== undefined) {\n\t\t\tvar saved = localStorage.getItem(this._storageId)\n\t\t\tif (saved != null) {\n\t\t\t\treturn JSON.parse(saved)\n\t\t\t} else {\n\t\t\t\treturn null\n\t\t\t}\n\t\t} else {\n\t\t\treturn null\n\t\t}\n\t},\n\n\tpersist: function (options) {\n\t\tif (localStorage !== undefined) {\n\t\t\tvar saved = this._getSavedConfig()\n\t\t\tif (saved != null) {\n\t\t\t\toptions = $.extend({}, saved, options)\n\t\t\t}\n\t\t\tlocalStorage.setItem(this._storageId, JSON.stringify(options))\n\t\t}\n\t}\n})\n\nexport default Config\n","const baseBackendUrl = 'https://d1548rv5kyvrdp.cloudfront.net'\n\nexport default {\n\tbingKey: 'AgYJwt3nv3bZyK31EDXorMaO8aIix-5kAa32O5TTwFAhdVYtZdIKhw3ttntsmgqy',\n\tdataSources: ['follies', 'hills', 'milestones', 'defence', 'trails', 'rnli', 'nationalparks', 'coastallandmarks'],\n\tlegacyApiBackendBaseUrl: 'https://not_deployed.execute-api.eu-west-2.amazonaws.com/prod/',\n\tdataBackendBaseUrl: `${baseBackendUrl}/data/`,\n\tintegrationBackendBaseUrl: `${baseBackendUrl}/integration/`\n}\n","//heavily borrowed from www.movable-type.co.uk/scripts/latlong-gridref.html (MIT licence)\nimport proj4 from 'proj4'\n\nvar osgbProj = proj4(\n\t'+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs'\n)\n\nfunction pad(num, w) {\n\tvar n = num.toString()\n\twhile (n.length < w) n = '0' + n\n\treturn n\n}\n\nexport default {\n\tlatLngToGridRef: function (lat, lng) {\n\t\tvar digits = 10\n\n\t\tvar out = osgbProj.forward([lng, lat]) //from WSG84\n\t\tvar eastings = out[0]\n\t\tvar northings = out[1]\n\n\t\tdigits = digits === undefined ? 10 : Number(digits)\n\t\tif (isNaN(digits)) throw new Error('Invalid precision')\n\n\t\tvar e = Number(Number(eastings))\n\t\tvar n = Number(Number(northings))\n\n\t\tif (isNaN(e) || isNaN(n)) throw new Error('Invalid grid reference: ' + [lat, lng])\n\n\t\t// use digits = 0 to return numeric format (in metres)\n\t\tif (digits === 0) return pad(e, 6) + ',' + pad(n, 6)\n\n\t\t// get the 100km-grid indices\n\t\tvar e100k = Math.floor(e / 100000),\n\t\t\tn100k = Math.floor(n / 100000)\n\n\t\tif (e100k < 0 || e100k > 6 || n100k < 0 || n100k > 12) return ''\n\n\t\t// translate those into numeric equivalents of the grid letters\n\t\tvar l1 = 19 - n100k - ((19 - n100k) % 5) + Math.floor((e100k + 10) / 5)\n\t\tvar l2 = (((19 - n100k) * 5) % 25) + (e100k % 5)\n\n\t\t// compensate for skipped 'I' and build grid letter-pairs\n\t\tif (l1 > 7) l1++\n\t\tif (l2 > 7) l2++\n\t\tvar letPair = String.fromCharCode(l1 + 'A'.charCodeAt(0), l2 + 'A'.charCodeAt(0))\n\n\t\t// strip 100km-grid indices from easting & northing, and reduce precision\n\t\te = Math.floor((e % 100000) / Math.pow(10, 5 - digits / 2))\n\t\tn = Math.floor((n % 100000) / Math.pow(10, 5 - digits / 2))\n\n\t\tvar gridRef = letPair + ' ' + pad(e, digits / 2) + ' ' + pad(n, digits / 2)\n\n\t\treturn gridRef\n\t},\n\n\tosgbToLngLat: function (eastings, northings) {\n\t\tvar out = osgbProj.inverse([eastings, northings]) //to WSG84\n\t\treturn out\n\t},\n\n\tgridRefToOsgb: function (/*String*/ gridref) {\n\t\tgridref = String(gridref).trim()\n\t\tthis._determineGridRefType(gridref)\n\n\t\t// check for fully numeric comma-separated gridref format\n\t\tvar match = gridref.match(/^(\\d+),\\s*(\\d+)$/)\n\t\tif (match) return new OsGridRef(match[1], match[2])\n\n\t\t// validate format\n\t\tmatch = gridref.match(/^[A-Z]{2}\\s*[0-9]+\\s*[0-9]+$/i)\n\t\tif (!match) throw new Error('Invalid grid reference: ' + gridref)\n\n\t\t// get numeric values of letter references, mapping A->0, B->1, C->2, etc:\n\t\tvar l1 = gridref.toUpperCase().charCodeAt(0) - 'A'.charCodeAt(0)\n\t\tvar l2 = gridref.toUpperCase().charCodeAt(1) - 'A'.charCodeAt(0)\n\t\t// shuffle down letters after 'I' since 'I' is not used in grid:\n\t\tif (l1 > 7) l1--\n\t\tif (l2 > 7) l2--\n\n\t\t// convert grid letters into 100km-square indexes from false origin (grid square SV):\n\t\tvar e100km = ((l1 - 2) % 5) * 5 + (l2 % 5)\n\t\tvar n100km = 19 - Math.floor(l1 / 5) * 5 - Math.floor(l2 / 5)\n\n\t\t// skip grid letters to get numeric (easting/northing) part of ref\n\t\tvar en = gridref.slice(2).trim().split(/\\s+/)\n\t\t// if e/n not whitespace separated, split half way\n\t\tif (en.length == 1) en = [en[0].slice(0, en[0].length / 2), en[0].slice(en[0].length / 2)]\n\n\t\t//fix for grid refs technically part of the grid but outside of the uk\n\t\t//this helped to work this out: https://raw.githubusercontent.com/wu-lee/dinty/master/national-grid.png\n\t\tif (e100km >= 15) {\n\t\t\te100km -= 25\n\t\t}\n\t\tif (n100km > 20) {\n\t\t\tn100km -= 25\n\t\t}\n\n\t\t// validation\n\t\tif (e100km < -10 || n100km < -5)\n\t\t\tthrow new Error('Invalid grid reference: gridref=' + gridref + ', e100km=' + e100km + ', n100km=' + n100km)\n\t\tif (en.length != 2) throw new Error('Invalid grid reference: ' + gridref)\n\t\tif (en[0].length != en[1].length) throw new Error('Invalid grid reference: ' + gridref)\n\n\t\t// standardise to 10-digit refs (metres)\n\t\ten[0] = (en[0] + '00000').slice(0, 5)\n\t\ten[1] = (en[1] + '00000').slice(0, 5)\n\n\t\tvar e = parseInt(e100km + '00000') + parseInt(en[0])\n\t\tvar n = parseInt(n100km + '00000') + parseInt(en[1])\n\n\t\treturn [e, n]\n\t},\n\n\tgridRefToLngLat: function (/*String*/ gridref) {\n\t\tvar lngLat = this.gridRefToOsgb(gridref)\n\t\tvar out = osgbProj.inverse(lngLat) //to WSG84\n\t\treturn out\n\t},\n\n\t_determineGridRefType: function (gridref) {\n\t\tif (/^\\w\\s*\\d{3,}\\s*\\d{3,}$/.test(gridref)) {\n\t\t\tthrow new Error('Irish grid references currently unsupported: ' + gridref)\n\t\t}\n\t}\n}\n","import $ from 'jquery'\n\nvar FullScreenLink = function (config, leafletMap) {\n\tvar container = $('div.full-screen-link')\n\tif (container.length > 0) {\n\t\tvar link = $('<a href=\"#\">Open in full screen</a>')\n\t\tlink.click(function () {\n\t\t\tvar zoom = leafletMap.getZoom()\n\t\t\tvar centre = leafletMap.getCenter()\n\t\t\tvar newUrl =\n\t\t\t\tconfig.baseUrl +\n\t\t\t\t'index.html?datasources=trigs&startPosition=' +\n\t\t\t\tcentre.lat +\n\t\t\t\t',' +\n\t\t\t\tcentre.lng +\n\t\t\t\t'&startZoom=' +\n\t\t\t\tzoom\n\t\t\twindow.location.href = newUrl\n\t\t})\n\t\t$('div.full-screen-link').append(link)\n\t}\n}\n\nexport default FullScreenLink\n","export default window //if it isn't window, we'll be stubbing this module anyway\n","import global from './global.js'\nimport params from './params.js'\n\n//all taken from http://detectmobilebrowsers.com/ (licence is UNLICENSE - http://unlicense.org/)\n\nvar firstRegex =\n\t/(android|bb\\d+|meego).+mobile|avantgo|bada\\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i\n\nvar secondRegex =\n\t/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\\-(n|u)|c55\\/|capi|ccwa|cdm\\-|cell|chtm|cldc|cmd\\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\\-s|devi|dica|dmob|do(c|p)o|ds(12|\\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\\-|_)|g1 u|g560|gene|gf\\-5|g\\-mo|go(\\.w|od)|gr(ad|un)|haie|hcit|hd\\-(m|p|t)|hei\\-|hi(pt|ta)|hp( i|ip)|hs\\-c|ht(c(\\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\\-(20|go|ma)|i230|iac( |\\-|\\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\\/)|klon|kpt |kwc\\-|kyo(c|k)|le(no|xi)|lg( g|\\/(k|l|u)|50|54|\\-[a-w])|libw|lynx|m1\\-w|m3ga|m50\\/|ma(te|ui|xo)|mc(01|21|ca)|m\\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\\-2|po(ck|rt|se)|prox|psio|pt\\-g|qa\\-a|qc(07|12|21|32|60|\\-[2-7]|i\\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\\-|oo|p\\-)|sdk\\/|se(c(\\-|0|1)|47|mc|nd|ri)|sgh\\-|shar|sie(\\-|m)|sk\\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\\-|v\\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\\-|tdg\\-|tel(i|m)|tim\\-|t\\-mo|to(pl|sh)|ts(70|m\\-|m3|m5)|tx\\-9|up(\\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\\-|your|zeto|zte\\-/i\n\nvar devHack = params.test('mobile')\n\nexport default {\n\tisMobile: function () {\n\t\tif (devHack) {\n\t\t\treturn true\n\t\t} else {\n\t\t\tvar testString = global.navigator.userAgent || global.navigator.vendor || global.opera\n\t\t\treturn firstRegex.test(testString) || secondRegex.test(testString.substr(0, 4))\n\t\t}\n\t}\n}\n","export const ZOOM_OUT_EVENT = 'zoomOut'\nexport const ZOOM_IN_EVENT = 'zoomIn'\n\nexport function detectZoomDirection(map) {\n\tlet previousZoom = map.getZoom()\n\t//zoomstart would be better, so we can make changes to things before zooming, but at the zoomstart point you don't know whether you're zooming in or out\n\tmap.on('zoom', () => {\n\t\tlet currentZoom = map.getZoom()\n\t\tif (Number.isInteger(currentZoom)) {\n\t\t\t//wait for pinch-zooms to finish so we know we've settled on the final zoom level\n\t\t\t//high numbers are \"zoomed in\", low numbers are \"zoomed out\"\n\t\t\tif (currentZoom < previousZoom) {\n\t\t\t\tconsole.debug(`zoom out: from=${previousZoom} to=${currentZoom}`)\n\t\t\t\tmap.fire(ZOOM_OUT_EVENT)\n\t\t\t} else if (currentZoom > previousZoom) {\n\t\t\t\tconsole.debug(`zoom in: from=${previousZoom} to=${currentZoom}`)\n\t\t\t\tmap.fire(ZOOM_IN_EVENT)\n\t\t\t} //else ignore because they're the same (perhaps we're mid-zoom)\n\t\t\t//store for next time\n\t\t\tpreviousZoom = map.getZoom()\n\t\t}\n\t})\n}\n","import BingLayer from 'leaflet-plugins/layer/tile/Bing.js'\n\nexport default BingLayer\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport LeafletBing from 'VendorWrappers/bing-layer.js'\nimport constants from './constants.js'\n\nvar defaults = {\n\tkey: constants.bingKey\n}\nvar bingDefaults = leaflet.extend({maxZoom: 18, minZoom: 0, detectRetina: true}, defaults)\n\n//OS\nvar bingOsLayer = new LeafletBing(\n\tleaflet.extend(\n\t\t{\n\t\t\timagerySet: 'OrdnanceSurvey',\n\t\t\tminZoom: 12,\n\t\t\tmaxZoom: 18,\n\t\t\tmaxNativeZoom: 17\n\t\t},\n\t\tdefaults\n\t)\n) //note OS doesn't support retina\n//fallback layer because the OS maps don't scale well when you zoom out\nvar bingFallbackLayer = new LeafletBing(leaflet.extend({imagerySet: 'RoadOnDemand', maxZoom: 11, minZoom: 0}, defaults)) //note even though this layer supports retetina, having a group with a mix of retina and non-retina screws up the zooming\nvar bingOsGroup = leaflet.layerGroup([bingOsLayer, bingFallbackLayer])\n//Bing standard maps\nvar bingRoads = new LeafletBing(leaflet.extend({imagerySet: 'RoadOnDemand'}, bingDefaults))\nvar bingHybrid = new LeafletBing(leaflet.extend({imagerySet: 'AerialWithLabelsOnDemand'}, bingDefaults))\nvar bingAerial = new LeafletBing(leaflet.extend({imagerySet: 'Aerial'}, bingDefaults))\n//OSM\nvar osm = new leaflet.TileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n\tminZoom: 0,\n\tmaxZoom: 19,\n\tattribution: 'Map data  <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors'\n})\n\nvar layers = {\n\tOS: bingOsGroup,\n\t'Bing Roads': bingRoads,\n\t'Bing Satellite': bingAerial,\n\t'Bing Hybrid': bingHybrid,\n\tOSM: osm\n}\n\nfunction layerZoomExtractor(layers) {\n\tlet max = 0\n\tlet min = Number.MAX_SAFE_INTEGER\n\tlayers.forEach(layer => {\n\t\tif (layer.getLayers) {\n\t\t\tlet {max: subLayersMax, min: subLayersMin} = layerZoomExtractor(layer.getLayers())\n\t\t\tmax = Math.max(max, subLayersMax)\n\t\t\tmin = Math.min(min, subLayersMin)\n\t\t}\n\t\tif (layer.options?.maxZoom) {\n\t\t\tmax = Math.max(max, layer.options.maxZoom)\n\t\t}\n\t\tif (layer.options?.maxZoom) {\n\t\t\tmin = Math.min(min, layer.options.minZoom)\n\t\t}\n\t})\n\treturn {\n\t\tmax,\n\t\tmin\n\t}\n}\n//now go back through all layers and compile the overall min and max - this is safer than trying to know it up front and then enforce it on the layers\nconst {max: maxOverallZoom, min: minOverallZoom} = layerZoomExtractor(Object.values(layers))\n\nfunction _listenForLayerChange(layerId, layer, config) {\n\tlayer.on(\n\t\t'add',\n\t\tfunction () {\n\t\t\tconfig.persist({defaultLayer: layerId})\n\t\t}.bind(this)\n\t)\n}\n\nvar LayerAdder = function (map, config) {\n\t//if we have a default layer set, select that now\n\tvar layerToSelect = layers[config.defaultLayer]\n\tif (layerToSelect != null) {\n\t\tlayerToSelect.addTo(map)\n\t} else {\n\t\tbingOsGroup.addTo(map)\n\t}\n\n\t//set up listener to persist which layer is selected\n\tfor (var id in layers) {\n\t\t_listenForLayerChange(id, layers[id], config)\n\t}\n\n\treturn layers\n}\n\nexport default LayerAdder\nexport {maxOverallZoom, minOverallZoom}\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport $ from 'jquery'\nimport fullscreen_link from './fullscreen_link.js'\nimport mobile from './mobile.js'\nimport {detectZoomDirection} from './leaflet-plugins/zoom-detector.js'\nimport {maxOverallZoom, minOverallZoom} from './layers.js'\n\nvar MapView = leaflet.Class.extend({\n\tinitialize: function (config) {\n\t\tthis._config = config\n\t\tthis._createView()\n\t\t// set up the map\n\t\tthis._map = new leaflet.Map(this._config.map_element_id, {\n\t\t\t//these controls will be added by the controls module\n\t\t\tzoomControl: false,\n\t\t\t//set up the min and max zoom first to prevent the min/max changing when layers are loading, as this could change the zoom we set below in setView.\n\t\t\tminZoom: minOverallZoom,\n\t\t\tmaxZoom: maxOverallZoom\n\t\t})\n\n\t\t//set start point\n\t\tthis._map.setView(\n\t\t\tnew leaflet.LatLng(this._config.start_position[0], this._config.start_position[1]),\n\t\t\tthis._config.initial_zoom\n\t\t)\n\t\tfullscreen_link(this._config, this._map)\n\n\t\t//hook up listener to save the location when we move it\n\t\tthis._map.on(\n\t\t\t'zoomend moveend dragend',\n\t\t\tfunction () {\n\t\t\t\tthis._saveLocation()\n\t\t\t},\n\t\t\tthis\n\t\t)\n\n\t\t//hook up zoom in/out detector\n\t\tdetectZoomDirection(this._map)\n\t},\n\n\t//creates the html we need to display errors, loading screen and the map container\n\t_createView: function () {\n\t\tvar content = ''\n\n\t\tvar mapClass = ''\n\t\tif (this._config.map_style == 'mini' || this._config.map_style == 'mini_embedded') {\n\t\t\tmapClass = ' class=\"mini-map\"'\n\t\t} else if (this._config.map_style == 'full') {\n\t\t\tmapClass = ' class=\"full-screen\"'\n\t\t} else if (this._config.map_style == 'embedded') {\n\t\t\tmapClass = ' class=\"embedded-map\"'\n\t\t}\n\n\t\tif (this._config.map_style == 'mini' || this._config.map_style == 'mini_embedded') {\n\t\t\tcontent += '<div class=\"mini-map\">'\n\t\t}\n\t\tcontent += '<div id=\"' + this._config.map_element_id + '\"' + mapClass + '></div>'\n\t\tif (this._config.map_style == 'mini') {\n\t\t\tcontent += '</div>'\n\t\t\tcontent += '<div class=\"full-screen-link\"></div>'\n\t\t}\n\n\t\tif (this._config.map_style == 'full') {\n\t\t\tthis._config.map_outer_container_element.addClass('full-screen')\n\t\t}\n\t\tif (mobile.isMobile()) {\n\t\t\tthis._config.map_outer_container_element.addClass('mobile')\n\t\t}\n\t\tthis._config.map_outer_container_element.prepend($(content))\n\t},\n\n\t_saveLocation: function () {\n\t\tvar center = this._map.getCenter()\n\t\tvar start_position = [center.lat, center.lng]\n\t\tvar initial_zoom = this._map.getZoom()\n\t\tif (localStorage !== undefined) {\n\t\t\tvar hash = {\n\t\t\t\tstart_position: start_position,\n\t\t\t\tinitial_zoom: initial_zoom\n\t\t\t}\n\t\t\tthis._config.persist(hash)\n\t\t\tconsole.debug(JSON.stringify(hash))\n\t\t}\n\t},\n\n\tgetMap: function () {\n\t\treturn this._map\n\t}\n})\n\nexport default MapView\n","import 'leaflet.markercluster/dist/MarkerCluster.Default.css'\nimport 'leaflet.markercluster/dist/MarkerCluster.css'\n\nimport leaflet_cluster from 'leaflet.markercluster'\n\nexport default leaflet_cluster\n","import SubGroup from 'leaflet.featuregroup.subgroup/dist/leaflet.featuregroup.subgroup-src.js'\nexport default SubGroup\n","import $ from 'jquery'\nimport _ from 'underscore'\nimport leaflet from 'VendorWrappers/leaflet.js'\nimport popupView from './popup_view.js'\nimport constants from './constants.js'\n\nexport default {\n\ttranslateMarker: function (markerConfig, bundleConfig, aspectName, manager) {\n\t\tvar latLng = markerConfig.latLng\n\t\tvar name = markerConfig.name\n\t\tvar extraTexts = markerConfig.extraTexts\n\t\tvar exportName = markerConfig.exportName\n\t\tvar icon = markerConfig.icon\n\t\tvar url = markerConfig.url\n\t\tvar visited = markerConfig.visited\n\n\t\tif (!popupView.notEmpty(name)) {\n\t\t\tname = url\n\t\t}\n\t\tif (popupView.notEmpty(exportName)) {\n\t\t\texportName = name\n\t\t}\n\n\t\tvar popupText = popupView.buildPopup(manager, name, url, latLng, extraTexts, visited)\n\n\t\tvar markerOptions = {}\n\t\tif (bundleConfig.icons != null && bundleConfig.icons[icon] != null) {\n\t\t\tmarkerOptions.icon = bundleConfig.icons[icon]\n\t\t} else if (bundleConfig.defaultIcon != null) {\n\t\t\tmarkerOptions.icon = bundleConfig.defaultIcon\n\t\t}\n\t\tmarkerOptions.layerId = markerConfig.layerId\n\t\tvar marker = leaflet.marker(latLng, markerOptions)\n\t\tvar popupElem = $('<div>' + popupText + '</div>')\n\t\tif (manager.shouldManageVisits()) {\n\t\t\t$('input', popupElem).change(function () {\n\t\t\t\tvar endpoint = ''\n\t\t\t\tif (this.checked) {\n\t\t\t\t\tendpoint = 'recordVisit'\n\t\t\t\t} else {\n\t\t\t\t\tendpoint = 'removeVisit'\n\t\t\t\t}\n\t\t\t\t$.post({\n\t\t\t\t\turl: constants.legacyApiBackendBaseUrl + endpoint,\n\t\t\t\t\tdata: JSON.stringify({\n\t\t\t\t\t\tsource: aspectName,\n\t\t\t\t\t\tname: markerConfig.id\n\t\t\t\t\t}),\n\t\t\t\t\tcontentType: 'application/json',\n\t\t\t\t\txhrFields: {\n\t\t\t\t\t\twithCredentials: true\n\t\t\t\t\t}\n\t\t\t\t}).catch(function (jqXhr, textStatus, errorThrown) {\n\t\t\t\t\tif (jqXhr.status == 401) {\n\t\t\t\t\t\tconsole.log('Authentication required')\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log('Request failed: ' + jqXhr.status + ', ' + textStatus + ', ' + errorThrown)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t}\n\t\tmarker.bindPopup(popupElem[0])\n\n\t\texportName = _.escape(markerConfig.exportName)\n\t\tvar cmt = null\n\t\tvar desc = null\n\t\tif (extraTexts != null) {\n\t\t\tcmt = _.escape(popupView.buildShortDescription(extraTexts)) //build the extra texts html but escape it to encode into the exported xml\n\t\t\tdesc = _.escape(popupView.buildDescription(extraTexts)) //build the extra texts html but escape it to encode into the exported xml\n\t\t}\n\t\t//selection control looks for .exportData in its default actions\n\t\tmarker.exportData = {\n\t\t\tname: exportName,\n\t\t\tlink: url,\n\t\t\tcmt: cmt,\n\t\t\tdesc: desc\n\t\t}\n\t\treturn marker\n\t}\n}\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport $ from 'jquery'\nimport {ZOOM_OUT_EVENT} from '../../leaflet-plugins/zoom-detector.js'\n\nexport const ENABLE_CLUSTERING_EVENT = 'enableClustering'\nexport const DISABLE_CLUSTERING_EVENT = 'disableClustering'\n\nexport const ClusteringEnabledControl = leaflet.Class.extend({\n\tinitialize: function (manager) {\n\t\tconst map = manager.getMap()\n\n\t\tthis._view = $('<div class=\"setting\"></div>')\n\t\tthis._clusteringEnabled = $('<input type=\"checkbox\" checked>')\n\t\tvar desc = $('<label>Clustering enabled?</label>')\n\t\tdesc.prepend(this._clusteringEnabled)\n\n\t\tlet lastDisabledZoomLevel = null\n\t\tthis._clusteringEnabled.on('change', event => {\n\t\t\tif (event.target.checked) {\n\t\t\t\tlastDisabledZoomLevel = null\n\t\t\t\tmap.fire(ENABLE_CLUSTERING_EVENT)\n\t\t\t} else {\n\t\t\t\tlastDisabledZoomLevel = map.getZoom()\n\t\t\t\tmap.fire(DISABLE_CLUSTERING_EVENT)\n\t\t\t}\n\t\t})\n\t\t//re-enable clustering if map is zoomed out past the level at which clustering was disabled, as this is quite likely to bring too many markers on to the screen - clustering can easily be re-disabled if desired.\n\t\t//note the zoom detector can only detect once zoom has started, thus we might not actually get to renable clustering until after the zoom has taken place.\n\t\tmap.on(ZOOM_OUT_EVENT, () => {\n\t\t\tlet currentZoom = map.getZoom()\n\t\t\t//low numbers are \"zoomed out\"\n\t\t\tif (lastDisabledZoomLevel != null && currentZoom < lastDisabledZoomLevel) {\n\t\t\t\t//tick the box in the UI and then trigger the event so that the listeners above will actually renable clustering\n\t\t\t\tthis._clusteringEnabled.prop('checked', true).trigger('change')\n\t\t\t}\n\t\t})\n\n\t\tthis._view.append(desc)\n\n\t\tvar clusteringInfo = $(\n\t\t\t'<div>Disable clustering with care! Disabling clustering when there are a large number of markers on screen could slow down or even crash your browser, particularly on mobile devices. Similarly, even if there are not a large number of markers currently visible, you may still have a problem if you disable clustering and then perform an action which brings more markers in to view (e.g. zooming out, adding data sources or simply panning to a location with more markers).</div>'\n\t\t)\n\t\tthis._view.append(clusteringInfo)\n\t},\n\n\tgetView: function () {\n\t\treturn this._view\n\t}\n})\n","import _ from 'underscore'\nimport $ from 'jquery'\nimport leaflet from 'leaflet'\nimport leaflet_cluster from 'VendorWrappers/leaflet-marker-cluster.js'\nimport 'leaflet.markercluster.freezable' //side effects on leaflet_cluster\nimport LeafletSubgroup from 'VendorWrappers/leaflet-subgroup.js'\nimport markerView from './marker_view.js'\nimport {ENABLE_CLUSTERING_EVENT, DISABLE_CLUSTERING_EVENT} from './menu/settings/clustering_enabled_control.js'\n\nvar PointsView = leaflet.Class.extend({\n\tinitialize: function (map, config, modelsByAspect, matrixLayerControl, controls, bundles, manager) {\n\t\tthis._map = map\n\t\tthis._config = config\n\t\tthis._modelsByAspect = modelsByAspect\n\t\tthis._matrixLayerControl = matrixLayerControl\n\t\tthis._controls = controls\n\t\tthis._bundles = bundles\n\t\tthis._parentGroup = null\n\t\tthis._manager = manager\n\t},\n\n\t_translateMarkerGroup: function (group, bundleConfig, aspect) {\n\t\tif (group != null) {\n\t\t\tif (group.constructor === Array) {\n\t\t\t\tgroup.forEach(function (markerConfig, i, group) {\n\t\t\t\t\tgroup[i] = markerView.translateMarker(markerConfig, bundleConfig, aspect, this._manager)\n\t\t\t\t}, this)\n\t\t\t} else {\n\t\t\t\t//is hash\n\t\t\t\tfor (var dimension in group) {\n\t\t\t\t\tgroup[dimension] = this._translateMarkerGroup(group[dimension], bundleConfig, aspect)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn group\n\t},\n\n\tfinish: function (finished) {\n\t\tvar deferredObject = $.Deferred()\n\n\t\tif (this._config.cluster) {\n\t\t\tvar mapElem = $('div#map')\n\t\t\tvar radius = Math.max(mapElem[0].offsetHeight, mapElem[0].offsetWidth) / 10\n\t\t\tthis._parentGroup = new leaflet_cluster.MarkerClusterGroup({\n\t\t\t\tdisableClusteringAtZoom: 15,\n\t\t\t\tmaxClusterRadius: radius,\n\t\t\t\tchunkedLoading: true,\n\t\t\t\tchunkProgress: function (processed, total, elapsed, layersArray) {\n\t\t\t\t\tif (processed === total) {\n\t\t\t\t\t\tdeferredObject.resolve()\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t\tthis._map.on(ENABLE_CLUSTERING_EVENT, () => {\n\t\t\t\tthis._parentGroup.enableClustering()\n\t\t\t})\n\t\t\tthis._map.on(DISABLE_CLUSTERING_EVENT, () => {\n\t\t\t\tthis._parentGroup.disableClustering()\n\t\t\t})\n\t\t} else {\n\t\t\tthis._parentGroup = leaflet.layerGroup()\n\t\t\tdeferredObject.resolve()\n\t\t}\n\n\t\tthis._parentGroup.addTo(this._map)\n\t\tif (!this._config.dimensional_layering) {\n\t\t\tvar markerLists = Object.keys(this._modelsByAspect)\n\t\t\t\t.map(\n\t\t\t\t\tfunction (aspect) {\n\t\t\t\t\t\tvar model = this._modelsByAspect[aspect]\n\t\t\t\t\t\treturn this._translateMarkerGroup(model.getMarkerList(), model.getBundleConfig(), aspect)\n\t\t\t\t\t}.bind(this)\n\t\t\t\t)\n\t\t\t\t.filter(function (value) {\n\t\t\t\t\treturn value != null\n\t\t\t\t})\n\t\t\tvar allMarkers = [].concat.apply([], markerLists)\n\t\t\tif (this._config.cluster) {\n\t\t\t\tvar nullLayerId = 'null'\n\t\t\t\tvar markersByLayer = allMarkers.reduce(function (markersByLayer, marker) {\n\t\t\t\t\tvar layerId = marker.options.layerId\n\t\t\t\t\tlayerId = layerId == null ? nullLayerId : layerId //because the Object.keys layer will coerce into a string anyway\n\t\t\t\t\tif (markersByLayer[layerId] == null) {\n\t\t\t\t\t\tmarkersByLayer[layerId] = []\n\t\t\t\t\t}\n\t\t\t\t\tmarkersByLayer[layerId].push(marker)\n\t\t\t\t\treturn markersByLayer\n\t\t\t\t}, {})\n\n\t\t\t\t//add things that don't specify a layer to the default clustered layer\n\t\t\t\tthis._parentGroup.addLayers(markersByLayer[nullLayerId])\n\t\t\t\t//add everything else to individual, non-clustered, layers\n\t\t\t\tObject.keys(markersByLayer)\n\t\t\t\t\t.filter(function (layerId) {\n\t\t\t\t\t\treturn layerId !== nullLayerId\n\t\t\t\t\t})\n\t\t\t\t\t.forEach(\n\t\t\t\t\t\tfunction (layerId) {\n\t\t\t\t\t\t\tvar markers = markersByLayer[layerId]\n\t\t\t\t\t\t\tvar layerGroup = leaflet.layerGroup()\n\t\t\t\t\t\t\tfor (var i = 0; i < markers.length; i++) {\n\t\t\t\t\t\t\t\tlayerGroup.addLayer(markers[i])\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tlayerGroup.addTo(this._map)\n\t\t\t\t\t\t}.bind(this)\n\t\t\t\t\t)\n\t\t\t} else {\n\t\t\t\tfor (var i = 0; i < allMarkers.length; i++) {\n\t\t\t\t\tthis._parentGroup.addLayer(allMarkers[i])\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tfor (var aspect in this._modelsByAspect) {\n\t\t\t\tvar model = this._modelsByAspect[aspect]\n\t\t\t\tthis.addClusteredModel(aspect, model)\n\t\t\t}\n\t\t}\n\n\t\treturn deferredObject.promise()\n\t},\n\n\taddClusteredModel: function (aspect, model) {\n\t\tif (model.getMarkerList() != null) {\n\t\t\tvar markerList = this._translateMarkerGroup(model.getMarkerList(), model.getBundleConfig(), aspect)\n\t\t\tvar matrixOverlays = {}\n\t\t\tthis.depthFirstIteration(markerList, '', matrixOverlays)\n\t\t\tvar aspectOptions = this._bundles[aspect] //will have other options, but collisions are unlikely\n\t\t\tthis._matrixLayerControl.addAspect(aspect, matrixOverlays, aspectOptions)\n\t\t}\n\t},\n\n\tdepthFirstIteration: function (markers, path, overlays) {\n\t\tif (markers.constructor === Array) {\n\t\t\tvar subGroup = new LeafletSubgroup(this._parentGroup, markers)\n\t\t\t//don't add to the map yet - let the layer control do that if it thinks it needs to - otherwise we could add all layers then immediately try to remove them all, which can cause UI weirdness\n\t\t\toverlays[path] = subGroup\n\t\t} else {\n\t\t\tObject.keys(markers).forEach(\n\t\t\t\tfunction (dimValue) {\n\t\t\t\t\tvar newPath = path.length === 0 ? dimValue : path + '/' + dimValue\n\t\t\t\t\tvar sublist = markers[dimValue]\n\t\t\t\t\tthis.depthFirstIteration(sublist, newPath, overlays)\n\t\t\t\t}.bind(this)\n\t\t\t)\n\t\t}\n\t}\n})\n\nexport default PointsView\n","import $ from 'jquery'\nimport leaflet from 'VendorWrappers/leaflet.js'\n\nvar GeojsonView = leaflet.Class.extend({\n\tinitialize: function (map, config, modelsByAspect, matrixLayerControl, bundles) {\n\t\tthis._map = map\n\t\tthis._config = config\n\t\tthis._modelsByAspect = modelsByAspect\n\t\tthis._matrixLayerControl = matrixLayerControl\n\t\tthis._bundles = bundles\n\t},\n\n\tfinish: function (finished) {\n\t\tif (!this._config.dimensional_layering && Object.keys(this._modelsByAspect).length > 0) {\n\t\t\tthrow new Error('!dimensional_layering is not supported yet.')\n\t\t} else {\n\t\t\tvar parentGroup = leaflet.layerGroup()\n\t\t\tvar markerLists = Object.keys(this._modelsByAspect).forEach(\n\t\t\t\tfunction (aspect) {\n\t\t\t\t\tvar model = this._modelsByAspect[aspect]\n\t\t\t\t\tthis.addClusteredModel(aspect, model)\n\t\t\t\t}.bind(this)\n\t\t\t)\n\t\t}\n\t\t//no async here, but stick to the convention of the other views\n\t\treturn $.Deferred().resolve().promise()\n\t},\n\n\taddClusteredModel: function (aspect, model) {\n\t\tvar aspectOptions = this._bundles[aspect] //will have other options, but collisions are unlikely\n\t\tvar layers = model.buildLayers()\n\t\tObject.values(layers).forEach(\n\t\t\tfunction (layer) {\n\t\t\t\tlayer.addTo(this._map)\n\t\t\t}.bind(this)\n\t\t)\n\t\tthis._matrixLayerControl.addAspect(aspect, layers, aspectOptions)\n\t}\n})\n\nexport default GeojsonView\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport params from '../params.js'\n\nvar UrlHandler = leaflet.Class.extend({\n\tinitialize: function () {\n\t\tthis._tester = new params.tester()\n\t},\n\n\tsourceLoaded: function (sourceName) {\n\t\tthis._tester.update()\n\t\tvar params = this._tester.getParams()\n\t\tvar datasource = params['datasources']\n\t\tdatasource = datasource == null ? '' : datasource\n\t\tdelete params['datasources']\n\t\tdatasource = datasource.length > 0 ? datasource + ',' + sourceName : sourceName\n\t\tvar newParams = Object.keys(params)\n\t\t\t.map(function (paramKey) {\n\t\t\t\treturn paramKey + '=' + params[paramKey]\n\t\t\t})\n\t\t\t.join('&')\n\t\tnewParams = (newParams.length > 0 ? newParams + '&' : '') + 'datasources=' + datasource\n\t\tvar newUrl = document.location.origin + document.location.pathname + '?' + newParams\n\t\t//history.replaceState({}, \"GeoBagging\", newUrl);//do nothing for now until we come up with a nice way to make this bookmarkable\n\t}\n})\n\nexport default UrlHandler\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport $ from 'jquery'\nimport PointsView from './points_view.js'\nimport GeojsonView from './geojson_view.js'\nimport AbstractPointsBuilder from './bundles/abstract_points_builder.js'\nimport AbstractGeojsonBuilder from './bundles/abstract_geojson_builder.js'\nimport UrlHandler from './utils/url_handler.js'\n\nvar ModelViews = leaflet.Class.extend({\n\tinitialize: function (bundles, manager) {\n\t\tthis._bundles = bundles\n\t\tthis._manager = manager\n\t\tthis._controls = manager.getControls()\n\t\tthis._urlHandler = new UrlHandler()\n\t},\n\n\t_filterModels: function (bundleModels, className) {\n\t\tvar matchingModels = {}\n\t\tObject.keys(bundleModels)\n\t\t\t.filter(function (bundleName) {\n\t\t\t\tvar model = bundleModels[bundleName]\n\t\t\t\treturn model instanceof className\n\t\t\t})\n\t\t\t.forEach(function (bundleName) {\n\t\t\t\tmatchingModels[bundleName] = bundleModels[bundleName]\n\t\t\t})\n\t\treturn matchingModels\n\t},\n\n\t_addLazyModels: function (lazyModels, addCallback) {\n\t\tObject.keys(lazyModels).forEach(\n\t\t\tfunction (bundleName) {\n\t\t\t\tvar model = lazyModels[bundleName]\n\t\t\t\tvar callback = function () {\n\t\t\t\t\tmodel.fetchData().done(\n\t\t\t\t\t\tfunction () {\n\t\t\t\t\t\t\taddCallback(bundleName, model)\n\t\t\t\t\t\t\tthis._addAttribution(bundleName, model)\n\t\t\t\t\t\t\tthis._urlHandler.sourceLoaded(bundleName)\n\t\t\t\t\t\t}.bind(this)\n\t\t\t\t\t)\n\t\t\t\t}.bind(this)\n\t\t\t\tvar meta = model.getMeta()\n\t\t\t\tvar description = meta.recordCount + ' items (last updated ' + meta.lastUpdated + ')'\n\t\t\t\tvar bundleDetails = this._bundles[bundleName]\n\t\t\t\tthis._manager.getMatrixLayerControl().addLazyAspect(bundleName, bundleDetails, {\n\t\t\t\t\tdescription: description,\n\t\t\t\t\tcallback: callback\n\t\t\t\t})\n\t\t\t}.bind(this)\n\t\t)\n\t},\n\n\t_addAttribution: function (bundleName, model) {\n\t\tvar attribution = model.getAttribution()\n\t\tif (attribution != null && attribution.length > 0) {\n\t\t\tvar dataSourceLabel = model.getBundleConfig().aspectLabel\n\t\t\tthis._controls.addAttribution(dataSourceLabel, attribution)\n\t\t}\n\t},\n\n\tloadModelViews: function (bundleModels, lazyModels, config, callback) {\n\t\tvar pointsModels = this._filterModels(bundleModels, AbstractPointsBuilder)\n\t\tvar geojsonModels = this._filterModels(bundleModels, AbstractGeojsonBuilder)\n\t\tvar lazyPointsModels = this._filterModels(lazyModels, AbstractPointsBuilder)\n\t\tvar lazyGeojsonModels = this._filterModels(lazyModels, AbstractGeojsonBuilder)\n\n\t\tvar pointsView = new PointsView(\n\t\t\tthis._manager.getMap(),\n\t\t\tconfig,\n\t\t\tpointsModels,\n\t\t\tthis._manager.getMatrixLayerControl(),\n\t\t\tthis._controls,\n\t\t\tthis._bundles,\n\t\t\tthis._manager\n\t\t)\n\t\tvar geojsonView = new GeojsonView(\n\t\t\tthis._manager.getMap(),\n\t\t\tconfig,\n\t\t\tgeojsonModels,\n\t\t\tthis._manager.getMatrixLayerControl(),\n\t\t\tthis._bundles\n\t\t)\n\t\tvar promises = [pointsView.finish(), geojsonView.finish()]\n\n\t\tif (config.dimensional_layering) {\n\t\t\tthis._addLazyModels(lazyPointsModels, function (bundleName, model) {\n\t\t\t\tpointsView.addClusteredModel(bundleName, model)\n\t\t\t})\n\t\t\tthis._addLazyModels(lazyGeojsonModels, function (bundleName, model) {\n\t\t\t\tgeojsonView.addClusteredModel(bundleName, model)\n\t\t\t})\n\t\t}\n\n\t\t$.when.apply($, promises).always(\n\t\t\tfunction () {\n\t\t\t\tif (config.dimensional_layering) {\n\t\t\t\t\t//override the basic layers control\n\t\t\t\t\tthis._controls.addControl(this._manager.getMatrixLayerControl())\n\t\t\t\t}\n\t\t\t\t//add attribution texts\n\t\t\t\tObject.keys(bundleModels).forEach(\n\t\t\t\t\tfunction (aspect) {\n\t\t\t\t\t\tvar model = bundleModels[aspect]\n\t\t\t\t\t\tthis._addAttribution(aspect, model)\n\t\t\t\t\t}.bind(this)\n\t\t\t\t)\n\t\t\t\tcallback()\n\t\t\t}.bind(this)\n\t\t)\n\t}\n})\n\nexport default ModelViews\n","import $ from 'jquery'\nimport leaflet from 'VendorWrappers/leaflet.js'\nimport constants from './constants.js'\nimport ModelViews from './model_views.js'\nimport params from './params.js'\n\nvar SourceLoader = leaflet.Class.extend({\n\tinitialize: function (manager, config) {\n\t\tthis._manager = manager\n\t\tthis._config = config\n\t},\n\n\tloadSources: function (selectedSourceIds) {\n\t\tvar extraDataSourcesString = params.test('extra-datasources')\n\t\tvar extraDataSources =\n\t\t\textraDataSourcesString != null && extraDataSourcesString.length > 0 ? extraDataSourcesString.split(',') : []\n\t\tvar sourceIds = $.uniqueSort(selectedSourceIds.concat(constants.dataSources, extraDataSources))\n\t\tvar sourceModuleIds = this._sourceIdsToDataSources(sourceIds)\n\t\tvar deferredObject = $.Deferred()\n\t\tvar sources = {}\n\t\tlet promises = sourceModuleIds.map(source => import('./bundles/' + source + '.js'))\n\t\tPromise.all(promises).then(modules => {\n\t\t\tmodules.forEach((sourceModule, i) => {\n\t\t\t\tsourceModule = sourceModule.default\n\t\t\t\tif (typeof sourceModule == 'function') {\n\t\t\t\t\tsourceModule = sourceModule(this._config)\n\t\t\t\t}\n\t\t\t\tsources[sourceModuleIds[i]] = sourceModule\n\t\t\t})\n\n\t\t\tvar sourceModels = {}\n\t\t\tvar lazyModels = {}\n\t\t\tvar promises = Object.keys(sources).map(\n\t\t\t\tfunction (sourceName) {\n\t\t\t\t\tvar source = sources[sourceName]\n\t\t\t\t\tvar parser = new source.parser(this._manager, source, sourceName)\n\n\t\t\t\t\tvar metaPromise = parser.fetchMeta()\n\t\t\t\t\tif (selectedSourceIds.indexOf(sourceName) != -1) {\n\t\t\t\t\t\tvar dataPromise = parser.fetchData()\n\t\t\t\t\t\tsourceModels[sourceName] = parser\n\t\t\t\t\t\treturn $.when(metaPromise, dataPromise)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlazyModels[sourceName] = parser\n\t\t\t\t\t\treturn metaPromise\n\t\t\t\t\t}\n\t\t\t\t}.bind(this)\n\t\t\t)\n\n\t\t\t$.when.apply($, promises).always(\n\t\t\t\tfunction () {\n\t\t\t\t\tvar modelViews = new ModelViews(sources, this._manager)\n\t\t\t\t\tmodelViews.loadModelViews(sourceModels, lazyModels, this._config, this._finish)\n\t\t\t\t\t//don't need to wait for ModelViews to finish, callback will update UI when the time comes, but can safely return after this call\n\t\t\t\t\tdeferredObject.resolve()\n\t\t\t\t}.bind(this)\n\t\t\t)\n\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis._finish()\n\t\t\t\tdeferredObject.resolve()\n\t\t\t}, 1)\n\t\t})\n\t\treturn deferredObject.promise() //TODO if one of the bundles is missing, we error, but the error is hidden...\n\t},\n\n\t_sourceIdsToDataSources: function (allSources) {\n\t\tif (allSources != null) {\n\t\t\tallSources = allSources.map(function (source) {\n\t\t\t\tif (source.indexOf('/') == -1) {\n\t\t\t\t\treturn source + '/config'\n\t\t\t\t} else {\n\t\t\t\t\treturn source\n\t\t\t\t}\n\t\t\t})\n\t\t} else {\n\t\t\tallSources = []\n\t\t}\n\t\treturn allSources\n\t},\n\n\t_finish: function () {\n\t\t$('div#loading-message-pane').hide()\n\t}\n})\n\nexport default SourceLoader\n","import MatrixControl from 'leaflet-matrix-layers-control'\n\nimport 'leaflet-matrix-layers-control/src/matrixControl.css'\n\nexport default MatrixControl\n","import ControlHider from 'leaflet-control-hider'\n\nimport 'leaflet-control-hider/src/hider.css'\n\nexport default ControlHider\n","import {BoxSelectorControl, BoxSelectorGpx} from 'VendorWrappers/leaflet-box-selector.js'\n\nvar SelectionControl = BoxSelectorControl.extend({\n\toptions: {\n\t\tactions: {\n\t\t\tgpx: {\n\t\t\t\tdisplay: 'Export to GPX file',\n\t\t\t\taction: BoxSelectorGpx(function () {\n\t\t\t\t\t//just append the date in case they export multiple - prevents the browser overwriting it\n\t\t\t\t\tvar d = new Date()\n\t\t\t\t\tvar dateString =\n\t\t\t\t\t\td.getFullYear() +\n\t\t\t\t\t\t'-' +\n\t\t\t\t\t\t(d.getMonth() + 1) +\n\t\t\t\t\t\t'-' +\n\t\t\t\t\t\td.getDate() +\n\t\t\t\t\t\t'_' +\n\t\t\t\t\t\td.getHours() +\n\t\t\t\t\t\t'-' +\n\t\t\t\t\t\td.getMinutes() +\n\t\t\t\t\t\t'-' +\n\t\t\t\t\t\td.getSeconds()\n\t\t\t\t\treturn 'geoPoints_' + dateString + '.gpx'\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t}\n})\n\nexport default SelectionControl\n","import leaflet_locate from 'leaflet.locatecontrol'\nimport 'leaflet.locatecontrol/dist/L.Control.Locate.min.css'\n\nvar Locate = leaflet_locate.extend({\n\toptions: {\n\t\tkeepCurrentZoomLevel: true,\n\t\tsetView: 'once'\n\t}\n})\n\nexport default Locate\n","import MousePosition from 'leaflet-mouse-position'\n\nimport 'leaflet-mouse-position/src/L.Control.MousePosition.css'\n\nexport default MousePosition\n","import Leaflet_MousePosition from 'VendorWrappers/leaflet-mouse-position.js'\nimport conversion from './conversion.js'\n\nvar MousePositionOsgb = Leaflet_MousePosition.extend({\n\toptions: {\n\t\tformatter: function (lng, lat) {\n\t\t\treturn conversion.latLngToGridRef(lat, lng)\n\t\t}\n\t}\n})\n\nexport default MousePositionOsgb\n","import MapCenterCoord from 'Leaflet.MapCenterCoord/src/L.Control.MapCenterCoord.js'\n\nimport 'Leaflet.MapCenterCoord/src/L.Control.MapCenterCoord.css'\n\nexport default MapCenterCoord\n","import Leaflet_ScreenPosition from 'VendorWrappers/leaflet-map-center-coord.js'\nimport conversion from './conversion.js'\nimport $ from 'jquery'\n\nvar ScreenPositionOsgb = Leaflet_ScreenPosition.extend({\n\toptions: {\n\t\tonMove: true,\n\t\ticon: true,\n\t\tlatLngFormatter: function (lat, lng) {\n\t\t\treturn conversion.latLngToGridRef(lat, lng)\n\t\t}\n\t},\n\n\taddTo: function (map) {\n\t\tLeaflet_ScreenPosition.prototype.addTo.call(this, map)\n\t\tthis._addShowHideHandling()\n\t},\n\n\t_addShowHideHandling: function () {\n\t\tvar $icon = $('div.leaflet-control-mapcentercoord-icon.leaflet-zoom-hide')\n\t\tvar isIconVisible = false\n\t\tvar $control = $('div.leaflet-control-mapcentercoord.leaflet-control')\n\n\t\tfunction hideIcon() {\n\t\t\t$icon.css('visibility', 'hidden')\n\t\t\tisIconVisible = false\n\t\t}\n\n\t\tfunction showIcon() {\n\t\t\t$icon.css('visibility', 'visible')\n\t\t\tisIconVisible = true\n\t\t}\n\n\t\t$control.click(function () {\n\t\t\tif (isIconVisible) {\n\t\t\t\thideIcon()\n\t\t\t} else {\n\t\t\t\tshowIcon()\n\t\t\t}\n\t\t})\n\t\t//start with crosshairs hidden\n\t\thideIcon()\n\t}\n})\n\nexport default ScreenPositionOsgb\n","import Sidebar from 'sidebar-v2/js/leaflet-sidebar.js'\n\nimport 'sidebar-v2/css/leaflet-sidebar.css'\n\nexport default Sidebar\n","import $ from 'jquery'\nimport leaflet from 'VendorWrappers/leaflet.js'\n\nvar AttributionView = leaflet.Class.extend({\n\tinitialize: function (container) {\n\t\tthis._container = container\n\t\tlet copyright = $(\n\t\t\t`<div class=\"attribution-entry\"></div>\n\t<span class=\"attribution-source\">Geo-bagging</span>\n\t<span>\n\t\tThe code on this site is copyright \n\t\t<a href=\"https://github.com/tstibbs\">tstibbs</a>/stripycoder, \n\t\tlicenced under AGPL, \n\t\tsource code available at \n\t\t<a href=\"https://github.com/tstibbs/geo-bagging\">here</a>.\n\t</span>\n\t<br />\n\t<span>\n\t\tMany open source libraries help make this project, see a full list in <a href=\"licenses.txt\">licenses.txt</a>.\n\t</span>\n</div>`\n\t\t)\n\t\tthis._container.append(copyright)\n\t},\n\n\taddAttribution: function (dataSourceName, text) {\n\t\tlet attribution = $(\n\t\t\t`<div class=\"attribution-entry\">\n\t<span class=\"attribution-source\">${dataSourceName} data</span>\n\t<span>${text}</span>\n</div>`\n\t\t)\n\t\tthis._container.append(attribution)\n\t}\n})\n\nexport default AttributionView\n","import $ from 'jquery'\nimport leaflet from 'VendorWrappers/leaflet.js'\nimport constants from '../constants.js'\n\nvar UserMenu = leaflet.Class.extend({\n\tinitialize: function (manager) {\n\t\tthis._view = $('<div class=\"setting\"></div>')\n\t\tif (manager.isAuthenticated()) {\n\t\t\tthis._view.append($('<span>Logged in as ' + manager.getLoggedInUser() + '</span>'))\n\t\t} else {\n\t\t\tthis._view.append($('<a href=\"' + constants.legacyApiBackendBaseUrl + 'login\">Click here to log in</a>'))\n\t\t}\n\t},\n\n\tgetView: function () {\n\t\treturn this._view\n\t}\n})\n\nexport default UserMenu\n","import $ from 'jquery'\nimport leaflet from 'VendorWrappers/leaflet.js'\nimport {ClusteringEnabledControl} from './clustering_enabled_control.js'\n\nvar SettingsView = leaflet.Class.extend({\n\tinitialize: function (manager) {\n\t\tthis._view = $('<div></div>')\n\n\t\tvar clusteringEnabledControl = new ClusteringEnabledControl(manager)\n\t\tthis._view.append(clusteringEnabledControl.getView())\n\t},\n\n\tgetView: function () {\n\t\treturn this._view\n\t}\n})\n\nexport default SettingsView\n","import leaflet from 'VendorWrappers/leaflet.js'\n\nconst ExternalSourceLoader = leaflet.Class.extend({\n\tinitialize: function (manager) {\n\t\tthis._manager = manager\n\t\tthis._displayedSources = []\n\t},\n\n\taddLayers: function (sourceName, fileNameToLayers) {\n\t\tObject.values(fileNameToLayers).forEach(layer => layer.addTo(this._manager.getMap()))\n\t\tif (!this._displayedSources.includes(sourceName)) {\n\t\t\tthis._displayedSources.push(sourceName)\n\t\t\tthis._manager.getMatrixLayerControl().addAspect(sourceName, fileNameToLayers, {\n\t\t\t\tdimensionNames: [sourceName]\n\t\t\t})\n\t\t} else {\n\t\t\tObject.entries(fileNameToLayers).forEach(([fileName, layer]) => {\n\t\t\t\tthis._manager.getMatrixLayerControl()._addMatrixOverlay(layer, fileName, sourceName)\n\t\t\t})\n\t\t}\n\t\t//force new layers to be visible initially - even if layers with those names were deselected in a previous session\n\t\tObject.keys(fileNameToLayers).forEach(fileName => this._setLayerVis(sourceName, fileName, true))\n\t\tthis._manager.getMatrixLayerControl()._onInputClick()\n\t\tthis._manager.getMatrixLayerControl()._update()\n\t},\n\n\thideLayers: function (sourceName, fileNameToLayers) {\n\t\tObject.entries(fileNameToLayers).forEach(([fileName, layer]) => {\n\t\t\tthis._setLayerVis(sourceName, fileName, false)\n\t\t\tlayer.remove()\n\t\t})\n\t},\n\n\t_setLayerVis: function (sourceName, fileName, visible) {\n\t\tthis._manager.getMatrixLayerControl()._model(sourceName).inputChanged(sourceName, fileName, visible)\n\t}\n})\n\nexport default ExternalSourceLoader\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport ExternalSourceLoader from '../../utils/external-source-loader.js'\nimport GeoJsonTranslator from '../../utils/geojson-translator.js'\n\nvar FilesView = leaflet.Class.extend({\n\tinitialize: function (manager, sourceName, colour, initialOutlineWidth) {\n\t\tthis._sourceName = sourceName\n\t\tthis._layers = {}\n\t\tthis._externalSourceLoader = new ExternalSourceLoader(manager)\n\t\tthis._translator = new GeoJsonTranslator(manager, colour, initialOutlineWidth)\n\t},\n\n\thideOldLayers: function () {\n\t\t//un-show the old layers\n\t\tthis._externalSourceLoader.hideLayers(this._sourceName, this._layers)\n\t},\n\n\tshowNewLayers: function (files) {\n\t\tlet layerData = files.map(({features, name}) => ({\n\t\t\tname,\n\t\t\tgeojson: features\n\t\t}))\n\t\tlet newLayers = this._translator.dataToLayers(layerData)\n\t\tthis._externalSourceLoader.addLayers(this._sourceName, newLayers)\n\t\tthis._layers = {...this._layers, ...newLayers}\n\t}\n})\n\nexport default FilesView\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport $ from 'jquery'\nimport FilesView from '../external-files/files_view.js'\n\nvar FileLoadView = leaflet.Class.extend({\n\tinitialize: function (manager, bundle) {\n\t\tthis._bundle = bundle\n\t\tthis._view = $('<div class=\"setting\"></div>')\n\t\tthis._view.append($(`<span>${this._bundle.loadLabel}: </span></br>`))\n\t\tthis._fileInput = $(`<input type=\"file\" accept=\"${this._bundle.loadExtensions}\" multiple>`)\n\t\tthis._view.append(this._fileInput)\n\t\tthis._fileInput.on('change', this._readFiles.bind(this))\n\t\tthis._fileCounter = 0\n\t\tthis._filesView = new FilesView(\n\t\t\tmanager,\n\t\t\tthis._bundle.aspectLabel,\n\t\t\tthis._bundle.colour,\n\t\t\tthis._bundle.initialOutlineWidth\n\t\t)\n\t},\n\n\t_readFiles: function () {\n\t\tvar datas = []\n\t\tvar files = this._fileInput[0].files\n\t\tfor (var i = 0; i < files.length; i++) {\n\t\t\t;(function (file) {\n\t\t\t\t//just scoping\n\t\t\t\tvar reader = new FileReader()\n\t\t\t\t//note this function is called asynchronously\n\t\t\t\treader.onload = function (e) {\n\t\t\t\t\tvar parsed = this._parseFileContents(reader.result)\n\t\t\t\t\tdatas.push({\n\t\t\t\t\t\tname: `${this._fileCounter} - ${file.name}`, //counter just to make the name unique\n\t\t\t\t\t\t...parsed\n\t\t\t\t\t})\n\t\t\t\t\tthis._fileCounter++\n\t\t\t\t\tif (datas.length == files.length) {\n\t\t\t\t\t\tthis._finishedReadingFiles(datas)\n\t\t\t\t\t}\n\t\t\t\t}.bind(this)\n\t\t\t\treader.readAsText(file)\n\t\t\t}.bind(this)(files.item(i)))\n\t\t}\n\t},\n\n\t_finishedReadingFiles: function (datas) {\n\t\t//datas is [{name, bounds, features}]\n\t\tthis._filesView.showNewLayers(datas)\n\t},\n\n\t_parseFileContents: function (fileContents) {\n\t\tconst {features, bounds} = this._bundle.fileContentsParser(fileContents)\n\t\treturn {\n\t\t\tfeatures,\n\t\t\tbounds\n\t\t}\n\t},\n\n\tgetView: function () {\n\t\treturn this._view\n\t}\n})\n\nexport default FileLoadView\n","import FileLoadView from '../external-files/file_load_view.js'\n\nvar FileConstraintLoadView = FileLoadView.extend({\n\tinitialize: function (manager, constraintsView, bundle) {\n\t\tFileLoadView.prototype.initialize.call(this, manager, bundle)\n\t\tthis._constraintsView = constraintsView\n\t},\n\n\t_finishedReadingFiles: function (tracks) {\n\t\tvar combinedBounds = tracks.map(function (track) {\n\t\t\treturn track.bounds\n\t\t})\n\t\tcombinedBounds = combinedBounds.flat()\n\t\tthis._constraintsView.limitTo(this, combinedBounds)\n\t\tFileLoadView.prototype._finishedReadingFiles.call(this, tracks)\n\t},\n\n\treset: function () {\n\t\tthis._fileInput.val('')\n\t\tthis._filesView.hideOldLayers()\n\t}\n})\n\nexport default FileConstraintLoadView\n","import FileConstraintLoadView from './file-constraint-load-view.js'\nimport gpxBundle from '../../bundles/external-gpx/config.js'\n\nconst label = 'Upload GPX tracks to see markers around those tracks'\n\nconst configBundle = {\n\t...gpxBundle,\n\taspectLabel: 'GPX Tracks',\n\tcolour: '#FF0000', //red\n\tloadLabel: label\n}\n\nvar TrackConstraintsLoadView = FileConstraintLoadView.extend({\n\tinitialize: function (manager, constraintsView) {\n\t\tFileConstraintLoadView.prototype.initialize.call(this, manager, constraintsView, configBundle)\n\t}\n})\n\nexport default TrackConstraintsLoadView\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport $ from 'jquery'\n\nvar CurrentLocationView = leaflet.Class.extend({\n\tinitialize: function (manager, constraintsView) {\n\t\tthis._manager = manager\n\t\tthis._constraintsView = constraintsView\n\n\t\tthis._view = $('<div class=\"setting\"></div>')\n\t\tvar currentLocationLimitButton = $('<button type=\"button\">Limit to 5 miles from current location</button>')\n\t\tcurrentLocationLimitButton.click(this._limitToCurrentLocation.bind(this))\n\t\tthis._view.append(currentLocationLimitButton)\n\t},\n\n\t_limitToCurrentLocation: function () {\n\t\tvar map = this._manager.getMap()\n\t\tvar listener = function (e) {\n\t\t\tmap.off('locationfound', listener) //only want to be called once\n\t\t\tvar lat = e.latlng.lat\n\t\t\tvar lng = e.latlng.lng\n\t\t\tvar latExtra = 0.08 //roughly 5 miles difference in lattitude in the UK\n\t\t\tvar lngExtra = 0.12 //roughly 5 miles difference in longitude in the UK\n\t\t\tvar latLngBounds = new leaflet.latLngBounds([lat + latExtra, lng + lngExtra], [lat - latExtra, lng - lngExtra])\n\t\t\tthis._constraintsView.limitTo(this, latLngBounds)\n\t\t}.bind(this)\n\t\tmap.on('locationfound', listener)\n\t\tmap.stopLocate()\n\t\tmap.locate()\n\t},\n\n\tgetView: function () {\n\t\treturn this._view\n\t},\n\n\treset: function () {\n\t\t//nothing to do\n\t}\n})\n\nexport default CurrentLocationView\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport $ from 'jquery'\n\nvar CurrentAreaView = leaflet.Class.extend({\n\tinitialize: function (manager, constraintsView) {\n\t\tthis._manager = manager\n\t\tthis._constraintsView = constraintsView\n\n\t\tthis._view = $('<div class=\"setting\"></div>')\n\t\tthis._currentAreaLimit = $('<input type=\"checkbox\">')\n\t\tvar desc = $('<label>Limit new markers to current area</label>')\n\t\tdesc.prepend(this._currentAreaLimit)\n\n\t\tthis._currentAreaLimit.change(\n\t\t\tfunction (event) {\n\t\t\t\tif (event.target.checked) {\n\t\t\t\t\tthis._constraintsView.limitTo(this, this._manager.getMap().getBounds())\n\t\t\t\t} else {\n\t\t\t\t\tthis._constraintsView.unlimit()\n\t\t\t\t}\n\t\t\t}.bind(this)\n\t\t)\n\n\t\tthis._view.append(desc)\n\t},\n\n\tgetView: function () {\n\t\treturn this._view\n\t},\n\n\treset: function () {\n\t\tthis._currentAreaLimit.prop('checked', false)\n\t}\n})\n\nexport default CurrentAreaView\n","import FileConstraintLoadView from './file-constraint-load-view.js'\nimport geojsonBundle from '../../bundles/external-geojson/config.js'\n\nconst label = 'Upload a GeoJSON file to see markers within the polygons specified in the geojson file'\n\nconst configBundle = {\n\t...geojsonBundle,\n\taspectLabel: 'GeoJson Constraints',\n\tcolour: 'orange',\n\tloadLabel: label\n}\n\nexport const GeoJsonConstraintLoadView = FileConstraintLoadView.extend({\n\tinitialize: function (manager, constraintsView) {\n\t\tFileConstraintLoadView.prototype.initialize.call(this, manager, constraintsView, configBundle)\n\t}\n})\n","import $ from 'jquery'\nimport leaflet from 'VendorWrappers/leaflet.js'\nimport TrackConstraintsLoadView from './track_load_view.js'\nimport CurrentLocationView from './current_location_view.js'\nimport CurrentAreaView from './current_area_view.js'\nimport {GeoJsonConstraintLoadView} from './geo-json-load-view.js'\n\nvar ConstraintsView = leaflet.Class.extend({\n\tinitialize: function (manager) {\n\t\tthis._manager = manager\n\t\tthis._limitOriginView = null //the view that triggered the current limits\n\t\tthis._view = $('<div></div>')\n\t\tvar info = $(\n\t\t\t'<div class=\"info\">This section allows you to limit how much data is displayed on screen. This can be useful for example when on older or mobile devices which may struggle to remain responsive if a large amount of data is loaded.</div>'\n\t\t)\n\t\tthis._view.append(info)\n\t\tthis._view.append('<hr class=\"info\">')\n\n\t\tvar currentAreaView = new CurrentAreaView(manager, this)\n\t\tthis._view.append(currentAreaView.getView())\n\n\t\tvar currentLocationView = new CurrentLocationView(manager, this)\n\t\tthis._view.append(currentLocationView.getView())\n\n\t\tthis._trackConstraintsLoadView = new TrackConstraintsLoadView(manager, this)\n\t\tthis._view.append(this._trackConstraintsLoadView.getView())\n\n\t\tthis._geoJsonConstraintLoadView = new GeoJsonConstraintLoadView(manager, this)\n\t\tthis._view.append(this._geoJsonConstraintLoadView.getView())\n\n\t\tvar reset = this._buildReset()\n\t\tthis._view.append(reset)\n\t},\n\n\t_buildReset: function () {\n\t\tvar wrapper = $('<div class=\"setting\"></div>')\n\t\tvar currentLocationLimitButton = $('<button type=\"button\">Reset</button>')\n\t\tcurrentLocationLimitButton.click(this.unlimit.bind(this))\n\t\twrapper.append(currentLocationLimitButton)\n\t\treturn wrapper\n\t},\n\n\tlimitTo: function (limitOriginView, /*LatLngBounds*/ bounds) {\n\t\tthis.unlimit()\n\t\tthis._limitOriginView = limitOriginView\n\t\tthis._manager.setViewConstraints(this._buildLimitFunction(bounds))\n\t\tif (this._constraintPolygon != null) {\n\t\t\tthis._constraintPolygon.remove()\n\t\t}\n\t\tvar polygonPoints = [\n\t\t\t[\n\t\t\t\t[-90, -180],\n\t\t\t\t[90, -180],\n\t\t\t\t[90, 180],\n\t\t\t\t[-90, 180]\n\t\t\t] //outer - should cover the entire map\n\t\t]\n\t\tif (!Array.isArray(bounds)) {\n\t\t\tbounds = [bounds]\n\t\t}\n\t\tbounds.forEach(function (hole) {\n\t\t\tpolygonPoints.push([hole.getSouthWest(), hole.getNorthWest(), hole.getNorthEast(), hole.getSouthEast()]) //hole\n\t\t})\n\t\tthis._constraintPolygon = new L.Polygon(polygonPoints, {\n\t\t\tcolor: 'rgb(0, 0, 0, 0)',\n\t\t\tfillColor: 'rgb(90, 90, 90)',\n\t\t\tfillOpacity: 0.3\n\t\t})\n\t\tthis._constraintPolygon.addTo(this._manager.getMap())\n\t},\n\n\t_buildLimitFunction: function (bounds) {\n\t\tif (Array.isArray(bounds)) {\n\t\t\treturn function (latLng) {\n\t\t\t\tfor (var i = 0; i < bounds.length; i++) {\n\t\t\t\t\tif (bounds[i].contains(latLng)) {\n\t\t\t\t\t\treturn true\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn false\n\t\t\t}\n\t\t} else {\n\t\t\treturn function (latLng) {\n\t\t\t\treturn bounds.contains(latLng)\n\t\t\t}\n\t\t}\n\t},\n\n\tunlimit: function () {\n\t\tif (this._limitOriginView != null) {\n\t\t\tthis._limitOriginView.reset()\n\t\t\tthis._limitOriginView = null\n\t\t}\n\t\tthis._manager.setViewConstraints(null)\n\t\tif (this._constraintPolygon != null) {\n\t\t\tthis._constraintPolygon.remove()\n\t\t}\n\t},\n\n\tgetView: function () {\n\t\treturn this._view\n\t}\n})\n\nexport default ConstraintsView\n","import $ from 'jquery'\nimport leaflet from 'VendorWrappers/leaflet.js'\nimport FileLoadView from './file_load_view.js'\nimport geojsonBundle from '../../bundles/external-geojson/config.js'\nimport gpxBundle from '../../bundles/external-gpx/config.js'\n\nvar ExternalFilesView = leaflet.Class.extend({\n\tinitialize: function (manager) {\n\t\tthis._view = $('<div></div>')\n\t\tvar info = $(\n\t\t\t'<div class=\"info\">Load external files to overlay on to map. Parsing is basic and limited information will be loaded - overlays will be mostly just visuals.</div>'\n\t\t)\n\t\tthis._view.append(info)\n\t\tthis._view.append('<hr class=\"info\">')\n\n\t\tconst geojsonLoadView = new FileLoadView(manager, geojsonBundle)\n\t\tthis._view.append(geojsonLoadView.getView())\n\n\t\tconst gpxLoadView = new FileLoadView(manager, gpxBundle)\n\t\tthis._view.append(gpxLoadView.getView())\n\t},\n\n\tgetView: function () {\n\t\treturn this._view\n\t}\n})\n\nexport default ExternalFilesView\n","import $ from 'jquery'\nimport leaflet from 'VendorWrappers/leaflet.js'\nimport LeafletSidebar from 'VendorWrappers/sidebar.js'\nimport AttributionView from './attribution.js'\nimport UserView from './user.js'\nimport SettingsView from './settings/view.js'\nimport ConstraintsView from './constraints/view.js'\nimport ExternalFilesView from './external-files/files_load_panel.js'\nimport params from '../params.js'\n\nvar MenuView = leaflet.Class.extend({\n\tinitialize: function (manager) {\n\t\tthis._manager = manager\n\t\tthis._buildView()\n\t\tthis._buildControl()\n\t},\n\n\t_buildView: function () {\n\t\tvar view = ''\n\n\t\tvar classes = ['sidebar', 'collapsed', 'leaflet-container']\n\n\t\tvar showUserSettings = params.test('testing') == 'true'\n\n\t\t//top of the navigation bar\n\t\tview += '<div id=\"sidebar\" class=\"' + classes.join(' ') + '\">'\n\t\tview += '    <div class=\"sidebar-tabs\">'\n\t\tview += '        <ul role=\"tablist\">'\n\t\tview += '            <li><a href=\"#sidebar-layers\" role=\"tab\"><i class=\"fa fa-bars\"></i></a></li>'\n\t\tview += '            <li><a href=\"#sidebar-settings\" role=\"tab\"><i class=\"fa fa-sliders\"></i></a></li>'\n\t\tview += '            <li><a href=\"#sidebar-constraints\" role=\"tab\"><i class=\"fa fa-map-o\"></i></a></li>'\n\t\tview += '            <li><a href=\"#sidebar-external-files\" role=\"tab\"><i class=\"fa fa-plus-square-o\"></i></a></li>'\n\t\tview += '        </ul>'\n\n\t\t//bottom of the navigation bar\n\t\tview += '        <ul role=\"tablist\">'\n\t\tif (showUserSettings) {\n\t\t\tview += '            <li><a href=\"#sidebar-user\" role=\"tab\"><i class=\"fa fa-user\"></i></a></li>'\n\t\t}\n\t\tview += '            <li><a href=\"#sidebar-attribution\" role=\"tab\"><i class=\"fa fa-copyright\"></i></a></li>'\n\t\tview += '        </ul>'\n\t\tview += '    </div>'\n\n\t\t//tab contents\n\t\tview += '    <div class=\"sidebar-content\">'\n\t\tview += '        <div id=\"sidebar-layers\" class=\"sidebar-pane\">'\n\t\tview +=\n\t\t\t'            <h1 class=\"sidebar-header\">Layers<span class=\"sidebar-close\"><i class=\"fa fa-caret-left\"></i></span></h1>'\n\t\tview += '        </div>'\n\t\tview += '        <div id=\"sidebar-settings\" class=\"sidebar-pane\">'\n\t\tview +=\n\t\t\t'            <h1 class=\"sidebar-header\">Settings<span class=\"sidebar-close\"><i class=\"fa fa-caret-left\"></i></span></h1>'\n\t\tview += '        </div>'\n\t\tview += '        <div id=\"sidebar-constraints\" class=\"sidebar-pane\">'\n\t\tview +=\n\t\t\t'            <h1 class=\"sidebar-header\">Data Limits<span class=\"sidebar-close\"><i class=\"fa fa-caret-left\"></i></span></h1>'\n\t\tview += '        </div>'\n\t\tview += '        <div id=\"sidebar-external-files\" class=\"sidebar-pane\">'\n\t\tview +=\n\t\t\t'            <h1 class=\"sidebar-header\">External Files<span class=\"sidebar-close\"><i class=\"fa fa-caret-left\"></i></span></h1>'\n\t\tview += '        </div>'\n\t\tview += '        <div id=\"sidebar-attribution\" class=\"sidebar-pane\">'\n\t\tview +=\n\t\t\t'            <h1 class=\"sidebar-header\">Attribution<span class=\"sidebar-close\"><i class=\"fa fa-caret-left\"></i></span></h1>'\n\t\tview += '        </div>'\n\t\tif (showUserSettings) {\n\t\t\tview += '        <div id=\"sidebar-user\" class=\"sidebar-pane\">'\n\t\t\tview +=\n\t\t\t\t'            <h1 class=\"sidebar-header\">User Settings<span class=\"sidebar-close\"><i class=\"fa fa-caret-left\"></i></span></h1>'\n\t\t\tview += '        </div>'\n\t\t}\n\t\tview += '    </div>'\n\t\tview += '</div>'\n\n\t\tthis._view = $(view)\n\t\tthis._manager.getConfig().map_outer_container_element.append(this._view)\n\n\t\tvar attributionContainer = $('<div></div>')\n\t\t$('#sidebar-attribution', this._view).append(attributionContainer)\n\t\tthis._attributionView = new AttributionView(attributionContainer)\n\n\t\tif (showUserSettings) {\n\t\t\tvar userView = new UserView(this._manager)\n\t\t\t$('#sidebar-user', this._view).append(userView.getView())\n\t\t}\n\n\t\tvar settingsView = new SettingsView(this._manager)\n\t\t$('#sidebar-settings', this._view).append(settingsView.getView())\n\n\t\tvar constraintsView = new ConstraintsView(this._manager)\n\t\t$('#sidebar-constraints', this._view).append(constraintsView.getView())\n\n\t\tconst externalFilesView = new ExternalFilesView(this._manager)\n\t\t$('#sidebar-external-files', this._view).append(externalFilesView.getView())\n\t},\n\n\t_buildControl: function () {\n\t\tthis._control = new LeafletSidebar('sidebar')\n\t},\n\n\taddTo: function (map) {\n\t\tthis._control.addTo(map)\n\t},\n\n\tgetContainer: function () {\n\t\treturn this._view[0] //get raw dom element from jquery\n\t},\n\n\taddLayers: function (matrixLayerControl) {\n\t\t$('#sidebar-layers', this._view).append(matrixLayerControl.getContainer())\n\t},\n\n\taddAttribution: function (dataSourceName, text) {\n\t\tthis._attributionView.addAttribution(dataSourceName, text)\n\t}\n})\n\nexport default MenuView\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport $ from 'jquery'\nimport Leaflet_ControlHider from 'VendorWrappers/leaflet-control-hider.js'\nimport Selection from './selection.js'\nimport Locate from './locate.js'\nimport mobile from './mobile.js'\nimport {GeosearchControl, GeosearchBing} from 'VendorWrappers/leaflet-geosearch.js'\nimport Mouseposition_Osgb from './mouseposition_osgb.js'\nimport Screenposition_Osgb from './screenposition_osgb.js'\nimport constants from './constants.js'\nimport MenuView from './menu/view.js'\nimport Leaflet_MatrixLayers from 'VendorWrappers/leaflet-matrix-layers-control.js'\n\n//even if some items aren't used in this particular configuration, we'll stick to a given order (resulting gaps are fine)\nvar order = [\n\tLeaflet_ControlHider,\n\tMenuView,\n\tleaflet.Control.Zoom,\n\tLocate,\n\tGeosearchControl,\n\tleaflet.Control.Layers, //matrix layers extends this, so will appear in the same slot\n\tSelection,\n\tMouseposition_Osgb,\n\tScreenposition_Osgb,\n\tleaflet.Control.Attribution\n]\n\nvar Controls = leaflet.Class.extend({\n\tinitialize: function (config, layers, map, manager) {\n\t\tthis._controlsToHide = []\n\t\tthis._controlsToAdd = []\n\t\tthis._config = config\n\t\tthis._layers = layers\n\t\tthis._manager = manager\n\t\tthis._addDefaults()\n\t\tif (map != null) {\n\t\t\tthis._addAllTo(map)\n\t\t}\n\t},\n\n\t_addDefaults: function () {\n\t\t//default leaflet controls\n\t\tvar configOverrides = {}\n\t\tif (this._config.use_sidebar) {\n\t\t\tthis._menuView = new MenuView(this._manager)\n\t\t\tthis.addControl(this._menuView)\n\t\t\tconfigOverrides = {position: 'topright'}\n\t\t}\n\t\tif (this._config.show_zoom_control) {\n\t\t\tthis.addControl(new leaflet.Control.Zoom(configOverrides))\n\t\t}\n\t\t//custom controls\n\t\tif (this._config.show_selection_control) {\n\t\t\tthis.addControl(new Selection())\n\t\t}\n\t\tif (this._config.show_search_control) {\n\t\t\tthis.addControl(\n\t\t\t\tnew GeosearchControl(\n\t\t\t\t\t$.extend(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tshowPopup: true,\n\t\t\t\t\t\t\tprovider: new GeosearchBing({\n\t\t\t\t\t\t\t\tkey: constants.bingKey\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t},\n\t\t\t\t\t\tconfigOverrides\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t)\n\t\t}\n\t\tif (\n\t\t\tthis._config.show_hider_control === true ||\n\t\t\t(this._config.show_hider_control == 'mobile' && mobile.isMobile())\n\t\t) {\n\t\t\tthis.addControl(\n\t\t\t\tnew Leaflet_ControlHider(this._controlsToHide, {\n\t\t\t\t\tvisibleByDefault: this._config.hider_control_start_visible\n\t\t\t\t})\n\t\t\t)\n\t\t}\n\t\tif (this._config.show_locate_control) {\n\t\t\tthis.addControl(new Locate(configOverrides))\n\t\t}\n\t\tif (this._config.show_layers_control && this._layers != null && Object.keys(this._layers).length > 1) {\n\t\t\tthis.addControl(new leaflet.Control.Layers(this._layers, null))\n\t\t}\n\t\tif (this._config.show_position_control) {\n\t\t\t//position displays\n\t\t\tif (mobile.isMobile()) {\n\t\t\t\tthis.addControl(new Screenposition_Osgb())\n\t\t\t} else {\n\t\t\t\tthis.addControl(new Mouseposition_Osgb())\n\t\t\t}\n\t\t}\n\t},\n\n\taddControl: function (control) {\n\t\tvar oldControl = null\n\t\tvar found = false\n\t\tfor (var i = 0; i < order.length; i++) {\n\t\t\tif (control instanceof order[i]) {\n\t\t\t\tif (this._controlsToAdd[i] != null) {\n\t\t\t\t\tif (console) {\n\t\t\t\t\t\tconsole.debug('Overwriting existing control \"' + this._controlsToAdd[i] + '\" with \"' + control + '\".')\n\t\t\t\t\t}\n\t\t\t\t\toldControl = this._controlsToAdd[i]\n\t\t\t\t}\n\t\t\t\tthis._controlsToAdd[i] = control\n\t\t\t\tif (!(control instanceof Leaflet_ControlHider)) {\n\t\t\t\t\tthis._controlsToHide.push(control)\n\t\t\t\t}\n\t\t\t\tfound = true\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tif (!found) {\n\t\t\tconsole.error('Unrecognised control: ' + control)\n\t\t\tthis._controlsToHide.push(control)\n\t\t\tthis._controlsToAdd[Math.max(order.length, this._controlsToAdd.length)] = control\n\t\t}\n\t\t//won't run for anything in addDefaults because this._map won't be populated at that point\n\t\tif (this._map != null) {\n\t\t\tcontrol.addTo(this._map) //add it, could be in the wrong place, but we'll move it later if necessary\n\t\t\tif (oldControl != null) {\n\t\t\t\tif (\n\t\t\t\t\tcontrol instanceof Leaflet_MatrixLayers &&\n\t\t\t\t\toldControl instanceof leaflet.Control.Layers &&\n\t\t\t\t\tthis._config.use_sidebar\n\t\t\t\t) {\n\t\t\t\t\t//remove standard layer control and put the new one on the menu\n\t\t\t\t\toldControl.remove()\n\t\t\t\t\tthis._menuView.addLayers(control)\n\t\t\t\t} else {\n\t\t\t\t\tvar newContainer = control._container\n\t\t\t\t\tvar oldContainer = oldControl._container\n\t\t\t\t\t$(newContainer).remove() //remove from incorrect location\n\t\t\t\t\t$(oldContainer).replaceWith(newContainer) //reattach at new location\n\t\t\t\t\toldControl.remove()\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\t_addAllTo: function (map) {\n\t\tthis._controlsToAdd.forEach(\n\t\t\tfunction (control) {\n\t\t\t\tif (control != null) {\n\t\t\t\t\tcontrol.addTo(map)\n\t\t\t\t}\n\t\t\t}.bind(this)\n\t\t)\n\t\tthis._map = map\n\t},\n\n\taddAttribution: function (dataSourceName, text) {\n\t\tif (this._config.use_sidebar) {\n\t\t\tthis._menuView.addAttribution(dataSourceName, text)\n\t\t}\n\t}\n})\n\nexport default Controls\n","import $ from 'jquery'\nimport leaflet from 'VendorWrappers/leaflet.js'\nimport Leaflet_MatrixLayers from 'VendorWrappers/leaflet-matrix-layers-control.js'\nimport Controls from './controls.js'\nimport layersBuilder from './layers.js'\nimport constants from './constants.js'\nimport params from './params.js'\n\n//basic manager class that simplifies interoperation between other components\nvar Manager = leaflet.Class.extend({\n\tinitialize: function (map, config) {\n\t\tthis._authenticated = false //default\n\t\tvar showUserSettings = params.test('testing') == 'true'\n\t\tif (showUserSettings) {\n\t\t\tthis._initializePromise = $.Deferred(\n\t\t\t\tfunction (deferred) {\n\t\t\t\t\t$.get({\n\t\t\t\t\t\turl: constants.legacyApiBackendBaseUrl + 'isAuthenticated',\n\t\t\t\t\t\txhrFields: {\n\t\t\t\t\t\t\twithCredentials: true\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t\t.then(\n\t\t\t\t\t\t\tfunction (data) {\n\t\t\t\t\t\t\t\tif (data == false) {\n\t\t\t\t\t\t\t\t\tthis._authenticated = false\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tthis._authenticated = true\n\t\t\t\t\t\t\t\t\tthis._loggedInUser = data.email\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tdeferred.resolve()\n\t\t\t\t\t\t\t}.bind(this)\n\t\t\t\t\t\t)\n\t\t\t\t\t\t.fail(\n\t\t\t\t\t\t\tfunction (xhr, textError, error) {\n\t\t\t\t\t\t\t\tif (xhr.status != 401) {\n\t\t\t\t\t\t\t\t\t//401 just means we're not logged in, it's not an error we need to report on\n\t\t\t\t\t\t\t\t\tconsole.error(\n\t\t\t\t\t\t\t\t\t\t'Failed to check authentication status - this can be ignored unless trying to record visits: ' +\n\t\t\t\t\t\t\t\t\t\t\ttextError\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\tconsole.log(error)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis._authenticated = false\n\t\t\t\t\t\t\t\tdeferred.resolve()\n\t\t\t\t\t\t\t}.bind(this)\n\t\t\t\t\t\t)\n\t\t\t\t}.bind(this)\n\t\t\t).promise()\n\t\t} else {\n\t\t\tthis._initializePromise = $.Deferred().resolve()\n\t\t}\n\t\tthis._initializePromise = this._initializePromise.always(\n\t\t\tfunction () {\n\t\t\t\tthis._map = map\n\t\t\t\tthis._config = config\n\t\t\t\tthis._layers = layersBuilder(map, config)\n\t\t\t\tif (this._config.dimensional_layering) {\n\t\t\t\t\tthis._matrixLayerControl = new Leaflet_MatrixLayers(\n\t\t\t\t\t\tthis._layers,\n\t\t\t\t\t\tnull,\n\t\t\t\t\t\t{},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmultiAspects: true,\n\t\t\t\t\t\t\tembeddable: this._config.use_sidebar\n\t\t\t\t\t\t}\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t\tthis._controls = new Controls(config, this._layers, map, this)\n\t\t\t}.bind(this)\n\t\t)\n\t},\n\n\twaitForInitialization: function () {\n\t\treturn this._initializePromise\n\t},\n\n\tsetViewConstraints: function (limitFunction) {\n\t\tthis._limitFunction = limitFunction //function(latLng) {return true or false}\n\t},\n\n\tgetViewConstraints: function () {\n\t\treturn this._limitFunction\n\t},\n\n\tgetControls: function () {\n\t\treturn this._controls\n\t},\n\n\tgetMap: function () {\n\t\treturn this._map\n\t},\n\n\tgetLayers: function () {\n\t\treturn this._layers\n\t},\n\n\tgetConfig: function () {\n\t\treturn this._config\n\t},\n\n\tgetMatrixLayerControl: function () {\n\t\treturn this._matrixLayerControl\n\t},\n\n\tsetAuthenticated: function (/*boolean*/ authenticated) {\n\t\tthis._authenticated = authenticated\n\t},\n\n\tisAuthenticated: function () {\n\t\treturn this._authenticated\n\t},\n\n\tshouldManageVisits: function () {\n\t\t//currently just checks that we're authenticated\n\t\treturn this.isAuthenticated()\n\t},\n\n\tgetLoggedInUser: function () {\n\t\treturn this._loggedInUser\n\t}\n})\n\nexport default Manager\n","import Config from './config.js'\nimport params from './params.js'\nimport $ from 'jquery'\nimport MapView from './map_view.js'\nimport SourceLoader from './source_loader.js'\nimport Manager from './manager.js'\n\nexport default {\n\tgetBundleIds: function (bundles) {\n\t\tvar allBundles = []\n\t\tif (bundles != null) {\n\t\t\tallBundles.push.apply(allBundles, bundles)\n\t\t}\n\t\tvar dataSourcesString = params.test('datasources')\n\t\tif (dataSourcesString != null && dataSourcesString.length > 0) {\n\t\t\tallBundles.push.apply(allBundles, dataSourcesString.split(','))\n\t\t}\n\t\t//legacy options\n\t\tif (params.test('hills') == 'true') {\n\t\t\tallBundles.push('hills')\n\t\t}\n\t\tif (params.test('trigs') == 'true') {\n\t\t\tallBundles.push('trigs')\n\t\t}\n\t\t//end legacy options\n\t\treturn allBundles\n\t},\n\n\tloadMap: function (options, bundleIds) {\n\t\tif (options == null) {\n\t\t\toptions = {}\n\t\t}\n\t\tvar allBundles = this.getBundleIds(bundleIds)\n\t\tif (this.hasUrlData()) {\n\t\t\talert('Loading data from URL is no longer an option.')\n\t\t\tthrow new Error('Loading data from URL is no longer an option.')\n\t\t} else if (options.pointsToLoad != null) {\n\t\t\tvar generalPoints = options.pointsToLoad.generalPoints\n\t\t\toptions.cluster = generalPoints.length > 300\n\t\t\toptions.dimensional_layering = false\n\t\t\tallBundles = ['trigs/config_embedding']\n\t\t}\n\t\toptions = $.extend(\n\t\t\t{\n\t\t\t\t//set some defaults that can be overriden by the page or by loadMiniMap\n\t\t\t\tcluster: true,\n\t\t\t\tdimensional_layering: true\n\t\t\t},\n\t\t\toptions\n\t\t)\n\n\t\tvar mapView = this._buildMap(options)\n\t\tvar manager = new Manager(mapView.getMap(), this._config)\n\t\treturn manager\n\t\t\t.waitForInitialization()\n\t\t\t.then(\n\t\t\t\tfunction () {\n\t\t\t\t\treturn new SourceLoader(manager, this._config).loadSources(allBundles)\n\t\t\t\t}.bind(this)\n\t\t\t)\n\t\t\t.then(function () {\n\t\t\t\treturn manager\n\t\t\t})\n\t},\n\n\tloadMiniMap: function () {\n\t\t//set some defaults that can be overriden by the page\n\t\tvar options = {\n\t\t\tcluster: false,\n\t\t\tdimensional_layering: false,\n\t\t\tinitial_zoom: 10,\n\t\t\tstart_position: [54.454463, -3.213515],\n\t\t\tshow_search_control: false,\n\t\t\tshow_locate_control: false,\n\t\t\tshow_hider_control: true,\n\t\t\thider_control_start_visible: false,\n\t\t\tmap_style: 'mini',\n\t\t\tuse_sidebar: false\n\t\t}\n\t\tvar bundles = ['trigs/config_mini']\n\t\tthis.loadMap(options, bundles)\n\t},\n\n\t_buildMap: function (options) {\n\t\tthis._config = new Config(options)\n\t\treturn new MapView(this._config)\n\t},\n\n\thasUrlData: function () {\n\t\treturn params.test('trigs') != null\n\t}\n}\n","import global from './global.js'\nimport leaflet from 'VendorWrappers/leaflet.js'\n\nvar ParamChecker = leaflet.Class.extend({\n\tinitialize: function () {\n\t\tthis.update()\n\t},\n\n\tupdate: function () {\n\t\tthis._params = {}\n\t\tvar search = global.location.search\n\t\tif (search.length > 0) {\n\t\t\tsearch = search.substr(1)\n\t\t\tvar paramString = search.split('&')\n\t\t\tparamString.forEach(\n\t\t\t\tfunction (item) {\n\t\t\t\t\tvar tmp = item.split('=')\n\t\t\t\t\tthis._params[tmp[0]] = decodeURIComponent(tmp[1])\n\t\t\t\t}.bind(this)\n\t\t\t)\n\t\t}\n\t},\n\n\tgetParams: function () {\n\t\treturn this._params\n\t},\n\n\ttest: function (key) {\n\t\treturn this._params[key]\n\t}\n})\n\nvar defaultInstance = new ParamChecker()\nexport default {\n\t//bit dirty, but 'test' function makes it easy to check params, while the 'tester' gives you a class you can instantiate to check stuff at the relevant time.\n\ttest: function (key) {\n\t\treturn defaultInstance.test(key)\n\t},\n\ttester: ParamChecker\n}\n","import _ from 'underscore'\n\nconst maxDisplayTextLength = 100\nconst maxDisplayArrayLength = 10\n\nexport default {\n\tnotEmpty: function (input) {\n\t\treturn input !== undefined && input !== null && input.length > 0\n\t},\n\n\t_truncateDisplayString: function (value) {\n\t\t//truncate values if they are long, to prevent popup boxes getting too large\n\t\tif (value.length > maxDisplayTextLength) {\n\t\t\treturn value.substring(0, maxDisplayTextLength - 3) + '...'\n\t\t} else {\n\t\t\treturn value\n\t\t}\n\t},\n\n\t_truncateDisplayArray: function (value) {\n\t\t//truncate values if they are long, to prevent popup boxes getting too large\n\t\tif (value.length > maxDisplayArrayLength) {\n\t\t\treturn [...value.slice(0, maxDisplayArrayLength), '...']\n\t\t} else {\n\t\t\treturn value\n\t\t}\n\t},\n\n\t_buildValue: function (value) {\n\t\tif (Array.isArray(value) && value.length == 2) {\n\t\t\treturn '<a href=\"' + this._truncateDisplayString(value[1]) + '\">' + value[0] + '</a>'\n\t\t} else {\n\t\t\treturn this._truncateDisplayString(value)\n\t\t}\n\t},\n\n\t_escapeValue: function (value) {\n\t\tif (Array.isArray(value)) {\n\t\t\treturn value.map(this._escapeValue.bind(this))\n\t\t} else {\n\t\t\treturn _.escape(value)\n\t\t}\n\t},\n\n\tbuildShortDescription: function (extraTexts) {\n\t\treturn Object.keys(extraTexts)\n\t\t\t.map(function (key) {\n\t\t\t\treturn extraTexts[key]\n\t\t\t})\n\t\t\t.filter(function (value) {\n\t\t\t\treturn value != null && value != ''\n\t\t\t})\n\t\t\t.map(function (value) {\n\t\t\t\tfunction extractValue(val) {\n\t\t\t\t\tif (Array.isArray(val) && val.length == 2) {\n\t\t\t\t\t\treturn val[0]\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn val\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\treturn value.map(extractValue).join('/')\n\t\t\t\t} else {\n\t\t\t\t\treturn extractValue(value)\n\t\t\t\t}\n\t\t\t})\n\t\t\t.join(', ')\n\t},\n\n\tbuildDescription: function (extraTexts) {\n\t\tvar popupText = ''\n\t\textraTexts.forEach(\n\t\t\tfunction (keyAndVal) {\n\t\t\t\tvar key = keyAndVal[0]\n\t\t\t\tvar value = keyAndVal[1]\n\t\t\t\tif (value != null && value != '') {\n\t\t\t\t\tif (popupText.length > 0) {\n\t\t\t\t\t\tpopupText += '<br />'\n\t\t\t\t\t}\n\t\t\t\t\tpopupText += '<span class=\"popup-entry-key\">' + key + ': </span>'\n\t\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\t\tif (value.length > 1) {\n\t\t\t\t\t\t\tvalue = this._truncateDisplayArray(value)\n\t\t\t\t\t\t\tpopupText += '<ul class=\"popup-entry-list\">'\n\t\t\t\t\t\t\tfor (var i = 0; i < value.length; i++) {\n\t\t\t\t\t\t\t\tpopupText += '<li>' + this._buildValue(value[i]) + '</li>'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tpopupText += '</ul>'\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tpopupText += '<span>' + this._buildValue(value[0]) + '</span>'\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tpopupText += '<span>' + this._buildValue(value) + '</span>'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}.bind(this)\n\t\t)\n\t\treturn popupText\n\t},\n\n\tbuildPopup: function (manager, unescapedName, unescapedUrl, latLng, unescapedExtraTexts, visited) {\n\t\t//get everything from the model - anything that gets put into the dom needs to be escaped to prevent XSS\n\t\tvar name = _.escape(unescapedName)\n\t\tvar url = _.escape(unescapedUrl)\n\t\tvar extraTexts = null\n\t\tif (unescapedExtraTexts != null) {\n\t\t\textraTexts = unescapedExtraTexts.map(\n\t\t\t\tfunction (keyAndVal) {\n\t\t\t\t\tvar key = keyAndVal[0]\n\t\t\t\t\tvar value = keyAndVal[1]\n\t\t\t\t\treturn [_.escape(key), this._escapeValue(value)]\n\t\t\t\t}.bind(this)\n\t\t\t)\n\t\t}\n\n\t\tvar popupText = '<div>'\n\t\tif (this.notEmpty(url)) {\n\t\t\tpopupText = '<a href=\"' + url + '\" class=\"popup-title\">' + name + '</a>'\n\t\t} else if (this.notEmpty(name)) {\n\t\t\tpopupText = '<span class=\"popup-title\">' + name + '</span>'\n\t\t}\n\t\tif (manager.shouldManageVisits() && visited != null) {\n\t\t\tpopupText += '<label class=\"fancy-checkbox\" title=\"Visited?\">'\n\t\t\tpopupText += '    <input type=\"checkbox\"' + (visited ? ' checked' : '') + '/>'\n\t\t\tpopupText += '    <i class=\"fa fa-check\"></i>'\n\t\t\tpopupText += '</label>'\n\t\t}\n\t\tif (extraTexts != null) {\n\t\t\tif (popupText.length > 0) {\n\t\t\t\tpopupText += '<br />'\n\t\t\t}\n\t\t\tpopupText += this.buildDescription(extraTexts)\n\t\t}\n\n\t\tif (latLng != null) {\n\t\t\tvar lat = latLng[0]\n\t\t\tvar lng = latLng[1]\n\t\t\tvar googleUrl = 'https://www.google.com/maps/place/' + lat + '+' + lng + '/@' + lat + ',' + lng + ',15z'\n\t\t\tvar bingUrl =\n\t\t\t\t'https://www.bing.com/maps/?mkt=en-gb&v=2&cp=' +\n\t\t\t\tlat +\n\t\t\t\t'~' +\n\t\t\t\tlng +\n\t\t\t\t'&lvl=14&sp=Point.' +\n\t\t\t\tlat +\n\t\t\t\t'_' +\n\t\t\t\tlng +\n\t\t\t\t'_' +\n\t\t\t\tname\n\t\t\tvar geohackUrl =\n\t\t\t\t'https://tools.wmflabs.org/geohack/geohack.php?pagename=' +\n\t\t\t\tname +\n\t\t\t\t'&params=' +\n\t\t\t\tlat +\n\t\t\t\t'_N_' +\n\t\t\t\tlng +\n\t\t\t\t'_E_region%3AGB_'\n\n\t\t\tpopupText += '<div class=\"expandable expandable-links\">'\n\t\t\tpopupText += '<input type=\"checkbox\" value=\"selected\" id=\"links-checkbox\" class=\"expandable-checkbox\">'\n\t\t\tpopupText +=\n\t\t\t\t'<label for=\"links-checkbox\" class=\"expandable-checkbox-label\"><i class=\"fa fa-external-link\" aria-hidden=\"true\"></i></label>'\n\t\t\tpopupText += '<div class=\"expandable-content links\">'\n\t\t\tpopupText += '<a href=\"' + googleUrl + '\">View on google maps</a>'\n\t\t\tpopupText += '<br /><a href=\"' + bingUrl + '\">View on bing maps</a>'\n\t\t\tpopupText += '<br /><a href=\"' + geohackUrl + '\">View on geohack</a>'\n\t\t\tpopupText += '</div>'\n\t\t\tpopupText += '</div>'\n\t\t}\n\n\t\tpopupText += '</div>'\n\t\treturn popupText\n\t}\n}\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport popupView from '../popup_view.js'\n\nconst selectedOutlineWidth = 3\n\nvar GeoJsonTranslator = leaflet.Class.extend({\n\tinitialize: function (manager, colour, initialOutlineWidth) {\n\t\tthis._manager = manager\n\t\tthis._colour = colour\n\t\tthis._initialOutlineWidth = initialOutlineWidth\n\t},\n\n\t_showAsSelected: function (layer) {\n\t\t// check first if we _can_ style, as some layers can be things like Marker objects which\n\t\t// don't have a setStyle function - this feels hacky but that's what they do in leaflet\n\t\t// (see https://github.com/Leaflet/Leaflet/blob/5e9e3c74902af8fbd834e483870c838a9d436e49/src/layer/GeoJSON.js#L156)\n\t\tif (layer.setStyle) {\n\t\t\tlayer.setStyle({\n\t\t\t\tweight: selectedOutlineWidth\n\t\t\t})\n\t\t}\n\t},\n\n\t_extractName: function (feature, extraInfos, fileName) {\n\t\tconst findAndExtract = (regex, fallback) => {\n\t\t\tlet index = extraInfos.findIndex(([key, value]) => regex.test(key))\n\t\t\tif (index != -1) {\n\t\t\t\tlet value = extraInfos[index][1]\n\t\t\t\tif (value != null && `${value}`.length > 0) {\n\t\t\t\t\tif (fallback) {\n\t\t\t\t\t\t//if it's a fallback property then prefix with the file name, otherwise it's unlikely it will make much sense\n\t\t\t\t\t\tvalue = `${fileName} / ${value}`\n\t\t\t\t\t} else {\n\t\t\t\t\t\t//if the property was something like 'name' then remove the element so it isn't shown in the infos section\n\t\t\t\t\t\textraInfos.splice(index, 1)\n\t\t\t\t\t}\n\t\t\t\t\treturn value //stop looking\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tlet name = null\n\t\t// properties that could be used for the name, in order of preference\n\t\tconst nameProperties = [/name/, /Name/, /name/i]\n\t\tconst fallBackProperties = [/ID/i, /OBJECTID/i, /GLOBALID/i]\n\t\tfor (let nameRegex of nameProperties) {\n\t\t\tname = findAndExtract(nameRegex, false)\n\t\t\tif (name != null) {\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tif (name == null) {\n\t\t\tfor (let nameRegex of fallBackProperties) {\n\t\t\t\tname = findAndExtract(nameRegex, true)\n\t\t\t\tif (name != null) {\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t//fallback if nothing suitable found\n\t\tif (name == null) {\n\t\t\tname = fileName\n\t\t}\n\t\tif (feature.properties == null) {\n\t\t\tfeature.properties = {}\n\t\t}\n\t\tfeature.properties.name = name\n\t},\n\n\t_buildExtraInfos: function (featureProperties) {\n\t\t//filter out blanks\n\t\tlet infos = []\n\t\tif (featureProperties != null) {\n\t\t\tinfos = Object.entries(featureProperties).filter(([key, value]) => value != null && `${value}`.length > 0)\n\t\t}\n\t\t//now get the props into shape for displaying\n\t\tconst gpxPropsToIgnore = ['sym', '_gpxType', 'coordTimes']\n\t\tconst gpxPrefixesToIgnore = ['SHAPE_']\n\t\tconst filterPropName = propName => {\n\t\t\treturn !gpxPropsToIgnore.includes(propName) && !gpxPrefixesToIgnore.some(prefix => propName.startsWith(prefix))\n\t\t}\n\t\t//filter out some gpx properties we know we don't want\n\t\tinfos = infos\n\t\t\t.filter(([key, value]) => filterPropName(key))\n\t\t\t//translate links from gpx into our format\n\t\t\t.map(([key, value]) => {\n\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\tvalue = value.map(entry => {\n\t\t\t\t\t\tlet linkValues = Object.entries(entry)\n\t\t\t\t\t\tif (linkValues.length == 1 && linkValues[0][0] == 'href') {\n\t\t\t\t\t\t\tlet url = linkValues[0][1]\n\t\t\t\t\t\t\treturn [url, url]\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn JSON.stringify(entry) //fallback, who knows what the structure is like, not much we can do\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\treturn [key, value]\n\t\t\t})\n\t\treturn infos\n\t},\n\n\tdataToLayers: function (layerDatas) {\n\t\t//add the new layers\n\t\tlet newLayers = Object.fromEntries(\n\t\t\tlayerDatas.map(layerData => {\n\t\t\t\tconst {name, url, geojson, extraInfos} = layerData\n\t\t\t\tconst nameToFeatures = {}\n\t\t\t\tconst onFeatureClick = e => {\n\t\t\t\t\tlet layer = e.target\n\t\t\t\t\tthis._showAsSelected(layer)\n\t\t\t\t\tlet featureName = layer.feature.properties.name\n\t\t\t\t\tif (featureName) {\n\t\t\t\t\t\tlet layers = nameToFeatures[featureName]\n\t\t\t\t\t\tif (layer != null) {\n\t\t\t\t\t\t\tlayers.forEach(this._showAsSelected)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlet geoJsonLayer = leaflet.geoJSON(geojson, {\n\t\t\t\t\tweight: this._initialOutlineWidth, //stroke width in pixels - aka border width\n\t\t\t\t\tcolor: this._colour,\n\t\t\t\t\tonEachFeature: (feature, layer) => {\n\t\t\t\t\t\tlet featureExtraInfos = extraInfos != undefined ? extraInfos : this._buildExtraInfos(feature.properties)\n\t\t\t\t\t\tthis._extractName(feature, featureExtraInfos, name)\n\t\t\t\t\t\tlet featureName = feature.properties.name\n\t\t\t\t\t\tvar visited = null //not supported on geojson sources for now\n\t\t\t\t\t\tvar popup = popupView.buildPopup(this._manager, featureName, url, null, featureExtraInfos, visited)\n\t\t\t\t\t\tlayer.bindPopup(popup)\n\t\t\t\t\t\tif (!(featureName in nameToFeatures)) {\n\t\t\t\t\t\t\tnameToFeatures[featureName] = []\n\t\t\t\t\t\t}\n\t\t\t\t\t\tnameToFeatures[featureName].push(layer)\n\t\t\t\t\t\tlayer.on({\n\t\t\t\t\t\t\tclick: onFeatureClick\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t//reset all styles when the map is clicked anywhere. Style will be re-added if it is one of these features that is clicked (same way the popups work)\n\t\t\t\tthis._manager.getMap().on({\n\t\t\t\t\tpreclick: () => {\n\t\t\t\t\t\tgeoJsonLayer.resetStyle()\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\treturn [name, geoJsonLayer]\n\t\t\t})\n\t\t)\n\t\treturn newLayers\n\t}\n})\n\nexport default GeoJsonTranslator\n","import leaflet from 'VendorWrappers/leaflet.js'\nimport {gpx as toGeoJSON} from '@tmcw/togeojson'\n\nexport function calcGeoJsonBounds(geoJson) {\n\tif (geoJson.type !== 'FeatureCollection') {\n\t\tconsole.log(`incompatible geoJson.type=${geoJson.type}, attempting to parse anyway...`)\n\t}\n\tlet multiBounds = geoJson.features.map(function (feature) {\n\t\tvar minLng = null\n\t\tvar maxLng = null\n\t\tvar minLat = null\n\t\tvar maxLat = null\n\t\tvar geometry = feature.geometry\n\t\tconst pointParser = point => {\n\t\t\tvar lng = point[0]\n\t\t\tvar lat = point[1]\n\t\t\tif (minLng == null || lng < minLng) {\n\t\t\t\tminLng = lng\n\t\t\t}\n\t\t\tif (maxLng == null || lng > maxLng) {\n\t\t\t\tmaxLng = lng\n\t\t\t}\n\t\t\tif (minLat == null || lat < minLat) {\n\t\t\t\tminLat = lat\n\t\t\t}\n\t\t\tif (maxLat == null || lat > maxLat) {\n\t\t\t\tmaxLat = lat\n\t\t\t}\n\t\t}\n\t\tvar lineParser = function (line) {\n\t\t\tline.forEach(pointParser)\n\t\t}\n\t\tif (geometry.type == 'MultiLineString' || geometry.type == 'Polygon') {\n\t\t\tgeometry.coordinates.forEach(lineParser)\n\t\t} else if (geometry.type == 'MultiPolygon') {\n\t\t\tgeometry.coordinates.forEach(polygon => polygon.forEach(lineParser))\n\t\t} else if (geometry.type == 'Point') {\n\t\t\tpointParser(geometry.coordinates)\n\t\t} else if (geometry.type == 'LineString' || geometry.type == 'MultiPoint') {\n\t\t\tlineParser(geometry.coordinates)\n\t\t} else {\n\t\t\tconsole.log(`Unhandled geometry type: ${geometry.type}`)\n\t\t\t//most likely something like this, worth a go\n\t\t\tlineParser(geometry.coordinates)\n\t\t}\n\t\tvar latAdjustment = 0.005 //just to extend the bounding box a bit\n\t\tvar lngAdjustment = 0.01\n\t\tvar bottomLeft = [minLat - latAdjustment, minLng - lngAdjustment]\n\t\tvar topRight = [maxLat + latAdjustment, maxLng + lngAdjustment]\n\t\treturn leaflet.latLngBounds(bottomLeft, topRight)\n\t})\n\treturn multiBounds\n}\n\nexport function rawGpxToGeoJson(gpxAsString) {\n\t//xml editing in nodejs is hard, so quick and dirty replace for common mistake in gpx files (url tag with value used instead of link tag with attribute)\n\tgpxAsString = gpxAsString.replace(/<url( [^>]+)?>(.+)<\\/url>/g, `<link href=\"$2\"></link>`)\n\tvar dom = new DOMParser().parseFromString(gpxAsString, 'text/xml')\n\tvar geoJson = toGeoJSON(dom)\n\tlet multiBounds = calcGeoJsonBounds(geoJson)\n\treturn {\n\t\tfeatures: geoJson,\n\t\tbounds: multiBounds\n\t}\n}\n\nexport function rawGeoJsonToGeoJson(geojsonAsString) {\n\tlet parsed = JSON.parse(geojsonAsString)\n\tlet multiBounds = calcGeoJsonBounds(parsed)\n\treturn {\n\t\tfeatures: parsed,\n\t\tbounds: multiBounds\n\t}\n}\n","import leaflet from 'leaflet'\n\nimport 'leaflet/dist/leaflet.css'\n\n// workaround for https://github.com/Leaflet/Leaflet/issues/4968\nimport iconUrl from 'leaflet/dist/images/marker-icon.png'\nimport retinaUrl from 'leaflet/dist/images/marker-icon-2x.png'\nimport shadowUrl from 'leaflet/dist/images/marker-shadow.png'\n\ndelete leaflet.Icon.Default.prototype._getIconUrl\n\nleaflet.Icon.Default.mergeOptions({\n\ticonRetinaUrl: retinaUrl,\n\ticonUrl: iconUrl,\n\tshadowUrl: shadowUrl\n})\n\nexport default leaflet\n"],"sourceRoot":""}